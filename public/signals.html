<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Infusion Test Analyzer</title>
    <meta name="description" content="Page Title" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no, user-scalable=no, minimal-ui"
    />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="msapplication-tap-highlight" content="no" />
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="/js/realtime_chart.js"></script>
      <script src="/js/overview_chart.js"></script>


    <!-- base css -->
    <link
      id="vendorsbundle"
      rel="stylesheet"
      media="screen, print"
      href="/css/vendors.bundle.css"
    />
    <link
      id="appbundle"
      rel="stylesheet"
      media="screen, print"
      href="/css/app.bundle.css"
    />
    
    <link id="mytheme" rel="stylesheet" media="screen, print" href="css/themes/cust-theme-4.css">
    <link
      id="myskin"
      rel="stylesheet"
      media="screen, print"
      href="/css/skins/skin-master.css"
    />
    <link
    id="myskin"
    rel="stylesheet"
    media="screen, print"
    href="/css/custom.css"
  />
    <!-- Place favicon.ico in the root directory -->
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="/img/favicon/apple-touch-icon.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="/img/favicon/favicon-32x32.png"
    />
    <link
      rel="mask-icon"
      href="/img/favicon/safari-pinned-tab.svg"
      color="#5bbad5"
    />
    
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script>
      const xt=new Date().getTime();
      let s = document.createElement('script');
      s.src = "/js/include.js?var" +xt;
      s.type = 'text/javascript';
      s.async = false;
      s.defer=true;
      let x = document.getElementsByTagName('script')[document.getElementsByTagName('script').length-1];
      x.parentNode.insertBefore(s, x);
    </script>

    
<link rel="manifest" href="%PUBLIC_URL%/manifest.json" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.0.3/socket.io.js"></script>
<style>

</style>

  </head>

  <body class="mod-skin-dark" onunload="clearBackGroundJob()">

    <script>

//1_RESET
//2_LIVE_SIGNAL
//3_OVERVIEW
//4_RESULT
var currentState="1_RESET";
const ADDITIONAL_GRAPH_WIDTH_SEC_DEFAULT=60;
const GRAPH_WIDTH_SEC_DEFAULT=10;
var patient_id="";
var patient_name="";

var  max_time_width_sec=60*30; //최대 저장시간 30분
var graph_width_sec=[];
var  annotation_regions=[null,null,null];
function graph_width_change(idx,tw)
{
  graph_width_sec[idx]=tw;


}

var noise_data_ICP=[];
var noise_data_ABP=[];

function showOverviewChart()
{
  const ABP_idx=findSignalIdxof("ABP");
 
    if(lineArr[ABP_idx])
    {

   //   if(lineArr[ABP_idx].length<125*60*5)
   if(lineArr[ABP_idx].length<5)
      {
          alert("You need to record for at least 5 minute to start infusion study.");
          return;
      }
      
    }
    else{
      alert("You need to record for at least 5 minute to start infusion study.");
      return;
    }
  
  clearBackGroundJobWithOutSocket();
  currentState="3_OVERVIEW";
  var action_key=$("#btn_record").html();
  if(action_key!="Record")
    record_stop();

    $(".hide_for_overview").css("display","none");
   $(".show_for_overview").css("display","inline-block")
    $("#chartlist").html("");
    parentId="chartlist";
    h=500;
    
    data_ABP_idx=findSignalIdxof("ABP");
    data_ICP_idx=findSignalIdxof("ICP");

   // annotation_regions=[null,null,null];
    annotation_data=[];
    noise_data_ICP=[];
    noise_data_ABP=[];
    
    drawOverviewChart(parentId,h,data_ABP_idx,data_ICP_idx,"ABP","ICP");


}

var resistance_of_shunt="";
var shunt_operating_pressure="";
var infusion_start="";
var infusion_duration="";
var infusion_rate="";


var baseline_mean_ICP="";
var baseline_mean_AMP="";
var plateau_mean_ICP="";
var plateau_mean_AMP="";
var Rcsf="";
var Pss="";
var csf_production_rate="";
var infused_volume="";
var elasticity="";
var PVI="";
var resultErrorCnt=0;
var infusion_start_date;
function finishParamInput()
{
  if($("#result_loading"))
    $("#result_loading").remove();

   if($("#exp_result_group"))
      $("#exp_result_group").remove("");
  xhtml='<div id="result_loading">';
  xhtml+='<div style="padding:50px;text-align:center;color:#c0c0c0;font-size:30pt;">loading...</div>';
  xhtml+='</div>';

  $("#chartlist").append(xhtml);
  
  currentState="4_RESULT";
  resistance_of_shunt=$("#resistance_of_shunt").val();
   shunt_operating_pressure=$("#shunt_operating_pressure").val();
   
   
   infusion_start_str=$("#infusion_start").val();
   infusion_start_date=new Date(infusion_start_str);
   infusion_start=infusion_start_date.getTime();
   infusion_duration=$("#infusion_duration").val();
   infusion_rate=$("#infusion_rate").val();

  obj={};
  obj["ABP_list"]=lineArr[findSignalIdxof("ABP")].map(function(obj){
        var rObj = {};
        rObj["x"] = obj.time.getTime();
        rObj["y"] = obj.x;
        return rObj;
      });
  
  obj["ICP_list"]=lineArr[findSignalIdxof("ICP")].map(function(obj){
        var rObj = {};
        rObj["x"] = obj.time.getTime();
        rObj["y"] = obj.x;
        return rObj;
      });
  
      obj["ABP_atf_list"]=noise_data_ABP.map(function(obj){
        var rObj = [];
        rObj[0] = obj[1];
        rObj[1] = obj[2];
        return rObj;
      });


      obj["ICP_atf_list"]=noise_data_ICP.map(function(obj){
        var rObj = [];
        rObj[0] = obj[1];
        rObj[1] = obj[2];
        return rObj;
      });
      
      
      
      var svg=d3.select("#chartlist svg");
      for(i=0;i<3;i++)
      {
        time_s=svg.select("#section"+i).attr("time_s");
        time_e=svg.select("#section"+i).attr("time_e");
        if(i==0)
        {
          baseline_start=time_s;
          baseline_end=time_e;
        }
        else if(i==1)
        {
          transient_start=time_s;
          transient_end=time_e;
        }        
        else 
        {
          plateau_start=time_s;
          plateau_end=time_e;
        }        

      }

  obj["exp_id"]=parseInt(exp_id);
  obj["baseline_start"]=baseline_start;
  obj["baseline_end"]=baseline_end;
  obj["transient_start"]=transient_start;
  obj["transient_end"]=transient_end;
  obj["plateau_start"]=plateau_start;
  obj["plateau_end"]=plateau_end;

  obj["resistance_of_shunt"]=resistance_of_shunt;
  obj["shunt_operating_pressure"]=shunt_operating_pressure;
  obj["infusion_rate"]=shunt_operating_pressure;
  
  obj["infusion_start"]=infusion_start;
  obj["infusion_duration"]=shunt_operating_pressure;

  getAPI3("/api_INFUSION/",obj,"POST",function(data){
  
    drawInfusionResult(data);
  },function(){

resultErrorCnt++;
if(resultErrorCnt<2)
  finishParamInput();

});
 


}

function drawInfusionResult(data)
{
console.log(data);
  currentState="4_RESULT";
  ICP_AMP_a=data.ICP_AMP_a;
    ICP_AMP_b=data.ICP_AMP_b;
    ICP_AMP_point_obj_list=data.ICP_AMP_point_obj_list;

    vol_pss_point_obj_list=data.vol_pss_point_obj_list;
    a=data.a;
    b=data.b;
    c=data.c;

    baseline_mean_ICP=data.baseline_mean_ICP.toFixed(2);;
    baseline_mean_AMP=data.baseline_mean_AMP.toFixed(2);;
    plateau_mean_ICP=data.plateau_mean_ICP.toFixed(2);;
    plateau_mean_AMP=data.plateau_mean_AMP.toFixed(2);;
    Rcsf=data.Rcsf.toFixed(2);;
    Pss=data.Pss.toFixed(2);;
    csf_production_rate=data.csf_production_rate.toFixed(2);;
    infused_volume=data.infused_volume.toFixed(2);;
    elasticity=data.elasticity.toFixed(2);;
    PVI=data.PVI.toFixed(2);;

    thtml='';
    thtml+='<div id="exp_result_group">';

    thtml+='<div id="chartlist_result" style=""></div>';

    thtml+='<div id="result_box" style="float:left;width:500px;height:800px;"></div>';

thtml+='<div id="chart_ICP_AMP" style="float:left;width:500px;height:300px;margin-right:10px;"></div>';
thtml+='<div id="chart_vol_pss" style="float:left;width:500px;height:300px;"></div>';

    thtml+='</div>';
   if($("#exp_result_group"))
      $("#exp_result_group").remove("");

    $("#result_loading").html("");
    $("#chartlist").append(thtml);

    
    drawICPAMPChart(ICP_AMP_a,ICP_AMP_b,ICP_AMP_point_obj_list,"chart_ICP_AMP");
    drawVolPssChart(a,b,c,vol_pss_point_obj_list,"chart_vol_pss");
    parentId="";
    AMP_arr=data.AMP_arr;
    RAP_arr=data.RAP_arr;
    chartname1="AMP";
    chartname2="RAP";
    drawOverviewChart_AMP_RAP("chartlist_result","500",AMP_arr,RAP_arr,chartname1,chartname2);

    showResult("result_box");

}
function pad2(n) { return n < 10 ? '0' + n : n }
function showResult(id)
{
  var date=new Date();
  date.setTime(infusion_start);
  
  infusion_start_str= date.getFullYear().toString() +"-"+ pad2(date.getMonth() + 1) +"-"+ pad2( date.getDate()) +" "+ pad2( date.getHours() ) +":"+ pad2( date.getMinutes() )  ;


  thtml="";
  thtml+='<div style="margin-left:60px;">';
  thtml+='<div class="row"><div class="col-6 result">resistance_of_shunt</div><div class="col-6 result">'+resistance_of_shunt+'</div></div>';
  thtml+='<div class="row"><div class="col-6 result">shunt_operating_pressure</div><div class="col-6 result">'+shunt_operating_pressure+'</div></div>';
  thtml+='<div class="row"><div class="col-6 result">infusion_start</div><div class="col-6 result">'+infusion_start_str+'</div></div>';
  thtml+='<div class="row"><div class="col-6 result">infusion_duration</div><div class="col-6 result">'+infusion_duration+'</div></div>';
  thtml+='<div class="row"><div class="col-6 result">infusion_rate</div><div class="col-6 result">'+infusion_rate+'</div></div>';
  thtml+='<div class="row"><div class="col-6 result">baseline_mean_ICP</div><div class="col-6 result">'+baseline_mean_ICP+'</div></div>';
  thtml+='<div class="row"><div class="col-6 result">baseline_mean_AMP</div><div class="col-6 result">'+baseline_mean_AMP+'</div></div>';
  thtml+='<div class="row"><div class="col-6 result">plateau_mean_ICP</div><div class="col-6 result">'+plateau_mean_ICP+'</div></div>';
  thtml+='<div class="row"><div class="col-6 result">plateau_mean_AMP</div><div class="col-6 result">'+plateau_mean_AMP+'</div></div>';

  thtml+='<div class="row"><div class="col-6 result">Rcsf</div><div class="col-6 result">'+Rcsf+'</div></div>';
  thtml+='<div class="row"><div class="col-6 result">Pss</div><div class="col-6 result">'+Pss+'</div></div>';
  thtml+='<div class="row"><div class="col-6 result">csf_production_rate</div><div class="col-6 result">'+csf_production_rate+'</div></div>';
  thtml+='<div class="row"><div class="col-6 result">infused_volume</div><div class="col-6 result">'+infused_volume+'</div></div>';
  thtml+='<div class="row"><div class="col-6 result">elasticity</div><div class="col-6 result">'+elasticity+'</div></div>';
  thtml+='<div class="row"><div class="col-6 result">PVI</div><div class="col-6 result">'+PVI+'</div></div>';
  thtml+='</div>';

  $("#"+id).html(thtml);
}

function drawVolPssChart(a,b,c,vlist,parent_id)
{
  var chartname="Vol Pss Chart";
  var margin = {top: 40, right: 10, bottom: 20, left:50};

  var w=500;
  var h=300;

  chart_width=w-margin.left-margin.right;
  chart_height=h-margin.top-margin.bottom;
  
  xmin=d3.min(vlist,function(c) { return parseInt(c.x)});
  xmax=d3.max(vlist,function(c) { return parseInt(c.x)});

  ymin=d3.min(vlist,function(c) { return parseInt(c.y)});
  ymax=d3.max(vlist,function(c) { return parseInt(c.y)});
  function xtoy(x)
  {
    return a*x*x+b*x+c;
  }
  
  data=[];
  idx=0;
  for(var i=xmin;i<xmax;i=i+0.01)
  {

    data[idx]={x:i,y:xtoy(i)};
    idx++;
  }


  var stroke_width=1.5;
  
  const svg = d3.select("#"+parent_id).append("svg")
    .attr("width", w)
    .attr("height", h)
    //.style("background-color","white");

    
    svg.append("defs").append("clipPath")
      .attr("id", "clipvol")
      .append("rect")
      .attr("x", margin.left)
      .attr("y", margin.top)
      .attr("width", chart_width )
      .attr("height", chart_height);

    XX = d3.scaleLinear().range([margin.left, chart_width+margin.left]); 
    YY = d3.scaleLinear().range([margin.top+chart_height, margin.top]);
    
    Ydomain_min=d3.min(data,function(c) { return c.y});

    Ydomain_max=d3.max(data,function(c) { return c.y});


    Xdomain=[d3.min(data,function(c) { return c.x}),d3.max(data,function(c) { return c.x})];
    Ydomain=[Ydomain_min,Ydomain_max];

    XX.domain(Xdomain);
    YY.domain(Ydomain);  
    

    svg
    .append("text")
    .attr("y", 20)
    .attr("x", 15)
    .attr("class", "chart_title_on_svg")
    .text(chartname)
    .attr("font-family", "sans-serif")
    .attr("font-size", "15px")
    .attr("fill", "black")
    .attr("text-anchor", "left");


    var xAxis=d3.axisBottom(XX).ticks(10);
  
    svg.append("g")
    .attr("class", "axis")
    .attr("transform", "translate(0," + (margin.top+chart_height) + ")")
    .call(xAxis)
    .selectAll("text")	
    .style("text-anchor", "middle");

 
    yAxis = d3.axisLeft().scale(YY);
  
    svg.append("g")
    .attr("class", "axis")
    .attr("transform", "translate("+margin.left+",0)")
    .call(yAxis);


    var valueline = d3.line()
      .x(function(d) { return XX(d.x) })
      .y(function(d) { return YY(d.y) });

    svg.append("path")
    .datum(data)
  
    .attr("fill", "none")
    .attr("stroke", "blue")
    .attr("stroke-linejoin", "round")
    .attr("stroke-linecap", "round")
    .attr("stroke-width", "1px")
    .attr("d", valueline);

    
    for(var i=0;i<vlist.length;i++)
    {
      svg.append("svg:circle") 
        .attr('cx', XX(vlist[i].x)) 
        .attr('cy', YY(vlist[i].y)) 
        .attr('r', 2)
        .attr("clip-path", "url(#clipvol)")
        .attr('fill', 'blue');
    }
}


function drawICPAMPChart(a,b,vlist,parent_id)
{
  var chartname="ICP-AMP Chart";
  var margin = {top: 40, right: 10, bottom: 20, left: 45};

  var w=500;
  var h=300;

  chart_width=w-margin.left-margin.right;
  chart_height=h-margin.top-margin.bottom;

  xmin=d3.min(vlist,function(c) { return parseInt(c.x)});
  xmax=d3.max(vlist,function(c) { return parseInt(c.x)});
  function xtoy(x)
  {
    return a*x+b;
  }
  
  data=[];
  idx=0;
  for(var i=xmin-1;i<xmax+1;i++)
  {

    data[idx]={x:i,y:xtoy(i)};
    idx++;
  }


  var stroke_width=1.5;
  
  const svg = d3.select("#"+parent_id).append("svg")
    .attr("width", w)
    .attr("height", h)
//    .style("background-color","white");

    svg.append("defs").append("clipPath")
      .attr("id", "clip")
      .append("rect")
      .attr("x", margin.left)
      .attr("y", margin.top)
      .attr("width", chart_width )
      .attr("height", chart_height);

    XX = d3.scaleLinear().range([margin.left, chart_width+margin.left]); 
    YY = d3.scaleLinear().range([margin.top+chart_height, margin.top]);
  
    Xdomain=[d3.min(data,function(c) { return c.x}),d3.max(data,function(c) { return c.x})];
    Ydomain=[d3.min(data,function(c) { return c.y}),d3.max(data,function(c) { return c.y})];

    XX.domain(Xdomain);
    YY.domain(Ydomain);  
    
    svg
    .append("text")
    .attr("y", 20)
    .attr("x", 15)
    .attr("class", "chart_title_on_svg")
    .text(chartname)
    .attr("font-family", "sans-serif")
    .attr("font-size", "15px")
    .attr("fill", "black")
    .attr("text-anchor", "left");


    var xAxis=d3.axisBottom(XX).ticks(7);
  
    svg.append("g")
    .attr("class", "axis")
    .attr("transform", "translate(0," + (margin.top+chart_height) + ")")
    .call(xAxis)
    .selectAll("text")	
    .style("text-anchor", "middle");

 
    yAxis = d3.axisLeft().scale(YY);
  
    svg.append("g")
    .attr("class", "axis")
    .attr("transform", "translate("+margin.left+",0)")
    .call(yAxis);

    var valueline = d3.line()
      .x(function(d) { return XX(d.x) })
      .y(function(d) { return YY(d.y) });

    svg.append("path")
    .datum(data)

    .attr("fill", "none")
    .attr("stroke", "red")
    .attr("stroke-linejoin", "round")
    .attr("stroke-linecap", "round")
    .attr("stroke-width", "1px")
    .attr("d", valueline);

    
    for(var i=0;i<vlist.length;i++)
    {
      svg.append("svg:circle") 
        .attr('cx', XX(vlist[i].x)) 
        .attr('cy', YY(vlist[i].y)) 
        .attr('r', 2)
        .attr("clip-path", "url(#clip)")
        .attr('fill', 'red');

        
    }
}
        
$("body").ready(function(){
 //     var thtml="";

//      thtml+=$("main").html();      
//      thtml+='<input type="button" onclick="putImage()" value="SAVE IMAGE" style="width:200px;display:inline-block"/>';
//      thtml+='<input type="button" onclick="apitest()" value="CHART CONVERT API TEST" style="float:left;width:200px;display:inline-block"/>';
//      thtml+='<input type="button" onclick="showOverviewChart()" value="Show Overview Chart " style="float:left;width:200px;display:inline-block"/>';

//      thtml+='<input type="file" id="fileUpload" />';
//      thtml+='<input type="button" id="upload" value="Upload" onclick="CsvUpload()" />';

//      thtml+='<input type="button" value="Start Analysis!" onclick="showInputParamPopup()" style="float:left;width:200px;display:inline-block"/>';
      

//      $("main").html(thtml);

    });


var calc_chart_update_timerId=null;
/*     function apitest()
    {
      //chart 그리기
      raw_signals[2]="CPP";
      chartCnt=3;
      lineArr[2]=[];
      lineArr_display[2]=[];
      
      thtml="";
      thtml+="<h2>"+raw_signals[2]+"</h2>";
      thtml+='<div id="chart'+2+'"></div>';
      thtml+="<hr/>";

      $("#chartlist").append(thtml);

      chart[2]=realTimeLineChart();

      //10초 간격 window 테스트 필요 
    if(calc_chart_update_timerId)
      clearInterval(calc_chart_update_timerId);
    else
      calc_chart_update_timerId = setInterval(calc_chart_update, 10000);

    } */



    
function calc_chart_update(chart_idx,signal_name)
{
  var obj={};
  const ABP_idx=findSignalIdxof("ABP");
  const ICP_idx=findSignalIdxof("ICP");

  var PPG_idx=-1;
  if(signal_name=="PPG2ABP")
     PPG_idx=findSignalIdxof("Pleth");

  window_size=300;
  signal_frequency=125;
  if(signal_name=="AMP"||signal_name=="CPP")
    window_size=10;
  
  if(signal_name=="PPG2ABP")
    window_size=8;

  if(lineArr[ABP_idx].length<signal_frequency*window_size)
    return;

  if(signal_name=="PPG2ABP")
  {
    signal=lineArr[PPG_idx].slice(lineArr[PPG_idx].length-signal_frequency*window_size,lineArr[PPG_idx].length);
   // obj["signalList"]=signal.map(function(obj){
   //    return  obj.x;
   //   });
  //  obj["signalList"]=signal;
  obj=signal.map(function(obj){
        var rObj = {};
        rObj["x"] = obj.time.getTime();
        rObj["y"] = obj.x;
        return rObj;
      });

  }
  else if(signal_name=="AMP"||signal_name=="SD1"||signal_name=="MRR"||signal_name=="SDNN"||signal_name=="RMSSD"||signal_name=="pNN50"||signal_name=="pNN20"||signal_name=="VLF"||signal_name=="LF"||signal_name=="HF") // HRD
  {
    //need to send ABP_signal as a converted format!

    signal=lineArr[ABP_idx].slice(lineArr[ABP_idx].length-signal_frequency*window_size,lineArr[ABP_idx].length);
   // obj["signalList"]=signal.map(function(obj){
   //    return  obj.x;
   //   });
  //  obj["signalList"]=signal;
  obj["signalList"]=signal.map(function(obj){
        var rObj = {};
        rObj["x"] = obj.time.getTime();
        rObj["y"] = obj.x;
        return rObj;
      });
  }
  else 
  {
    signal_frequency1=125;
    signal_frequency2=125;

    signal1=lineArr[ABP_idx].slice(lineArr[ABP_idx].length-signal_frequency1*window_size,lineArr[ABP_idx].length);
    obj["signalList1"]=signal1.map(function(obj){
        var rObj = {};
        rObj["x"] = obj.time.getTime();
        rObj["y"] = obj.x;
        return rObj;
      });
    signal2=lineArr[ICP_idx].slice(lineArr[ICP_idx].length-signal_frequency1*window_size,lineArr[ICP_idx].length);
    obj["signalList2"]=signal2.map(function(obj){
        var rObj = {};
        rObj["x"] = obj.time.getTime();
        rObj["y"] = obj.x;
        return rObj;
      });


  }

//signal_name
tsignal_name=signal_name;
var turl="/api_"+tsignal_name+"/";
if(tsignal_name=="PPG2ABP")
  turl="http://localhost:8001/v1/ppg2abp";
  
  getAPI2(turl,obj,"POST",function(data){


    var lineData={};
    if(tsignal_name=="PPG2ABP")
    {

      lineDataList=data.result.map(function(obj){
        var rObj = {};
//        var ttime=new Date();
//        ttime.setMilliseconds(obj.x);
        rObj["time"] = new Date(obj.x);
        rObj["x"] = obj.y;
        rObj["m"]="";
        return rObj;
      });

      lineArr[chart_idx]=lineArr[chart_idx].concat(lineDataList);
     
    }
    else if(tsignal_name=="SD1")
    {
      lineData["time"]=lineArr[ABP_idx][lineArr[ABP_idx].length-1].time;
      lineData["x"]=data;
      lineData["m"]="";
      lineArr[chart_idx].push(lineData);
    }
    else{
      lineData["time"]=new Date(data.x);
      lineData["x"]=data.y;
      lineData["m"]="";
      lineArr[chart_idx].push(lineData);
    }

   


  //차트 업데이트
    //d3.select("#chart"+i).datum(lineArr[2]).call(chart[2]);
       
  });


}
function exportAll()
{
  exportToCsv();

  var basefilename=getBaseFileName();
  if($(".region_handler"))
  {
    $(".region_handler").attr("opacity",0);
    $(".noise_handler").attr("opacity",0);

    if(currentState!="2_LIVE_SIGNAL"&&currentState!="1_RESET")
    {
      const svg1=$("#chartlist svg").get(0);
      downloadSvg(svg1, basefilename+"_ABP_and_ICP.png",null,null);

    }

    if(currentState=="4_RESULT")
    {
      exportResultToCsv();

      const svg2=$("#chart_ICP_AMP svg").get(0);
      
      downloadSvg(svg2, basefilename+"_ICP_AMP.png",500,300);

      const svg3=$("#chart_vol_pss svg").get(0);

      downloadSvg(svg3, basefilename+"_vol_pss.png",500,300);

      const svg4=$("#chartlist_result svg").get(0);
      downloadSvg(svg4, basefilename+"_AMP_and_RAP.png",null,null);
      

    }

    $(".region_handler").attr("opacity",1);
    $(".noise_handler").attr("opacity",1);
    
  }




}

function copyStylesInline(destinationNode, sourceNode) {
   var containerElements = ["svg","g"];
   for (var cd = 0; cd < destinationNode.childNodes.length; cd++) {
       var child = destinationNode.childNodes[cd];
       if (containerElements.indexOf(child.tagName) != -1) {
            copyStylesInline(child, sourceNode.childNodes[cd]);
            continue;
       }
       var style = sourceNode.childNodes[cd].currentStyle || window.getComputedStyle(sourceNode.childNodes[cd]);
       if (style == "undefined" || style == null) continue;
       for (var st = 0; st < style.length; st++){
            child.style.setProperty(style[st], style.getPropertyValue(style[st]));
       }
   }
}

function triggerDownload (imgURI, fileName) {
  var evt = new MouseEvent("click", {
    view: window,
    bubbles: false,
    cancelable: true
  });
  var a = document.createElement("a");
  a.setAttribute("download", fileName);
  a.setAttribute("href", imgURI);
  a.setAttribute("target", '_blank');
  a.dispatchEvent(evt);
}

function downloadSvg(svg, fileName,w,h) {
  var copy = svg.cloneNode(true);
  copyStylesInline(copy, svg);
  var canvas = document.createElement("canvas");
  var bbox = svg.getBBox();
  var tw=bbox.width;
  var th=bbox.height;
  if(w)
    tw=w;
  if(h)
    th=h;

  canvas.width = tw;
  canvas.height = th;
  canvas.id="tmp_canvas";
  canvas.style="background:#ffffff";
  var ctx = canvas.getContext("2d");
//  ctx.clearRect(0, 0, bbox.width, bbox.height);
  ctx.fillStyle = "white";
  ctx.fillRect(0, 0, bbox.width, bbox.height);

  var data = (new XMLSerializer()).serializeToString(copy);
  var DOMURL = window.URL || window.webkitURL || window;
  var img = new Image();
  var svgBlob = new Blob([data], {type: "image/svg+xml;charset=utf-8"});
  var url = DOMURL.createObjectURL(svgBlob);
  img.onload = function () {
    ctx.drawImage(img, 0, 0);
    DOMURL.revokeObjectURL(url);
    if (typeof navigator !== "undefined" && navigator.msSaveOrOpenBlob)
    {
        var blob = canvas.msToBlob();         
        navigator.msSaveOrOpenBlob(blob, fileName);
    } 
    else {
        var imgURI = canvas
            .toDataURL("image/png")
            .replace("image/png", "image/octet-stream");
        triggerDownload(imgURI, fileName);
    }
    document.getElementById("tmp_canvas").outerHTML = "";
  };

  //document.removeChild(canvas);
  img.src = url;
}

    </script>
    <noscript>You need to enable JavaScript to run this app.</noscript>
    <script>
      var DICT=[];
      DICT["ABP"]="ABP_1";

      

      var update_timer,upload_timer;
        var lineArr = [];
        var lineArr_display = [];
        var signal_frequency_list=[];
  
        var MAX_LENGTH = 100;
        var duration = 500;
       var chart=[] ;
       var raw_signals=[];
       var chartCnt=0;

      var socket;
      function init_websocket()
      {
        socket=io.connect('http://localhost:8005',{path:'/socket.io'});
      socket.on('data',function(datastr){
        data=JSON.parse(datastr);
          
          chartCnt=raw_signals.length;

          
          
          if(raw_signals.length==0)
            return;

          for(i=0;i<chartCnt;i++)
          {
            var signal_code=raw_signals[i];
            if(DICT[raw_signals[i]])
              signal_code=DICT[raw_signals[i]];
            
            if(signal_code==data.fields.SignalName.trim())
            {
              var time_zero=data.fields.Tzero.trim();
              signal_frequency_list[i]=data.fields.SignalFrequency.trim();
              var Datapoints=data.fields.Datapoints;
             
              for(j=0;j<1000;j++)
              {
                if(Datapoints[j.toString()])
                {
                  var tt=new Date(time_zero);
                  var the_v=Number(Datapoints[j.toString()]);                
                  tt.setMilliseconds(tt.getMilliseconds()+parseInt(j*1000/signal_frequency_list[i]));
                  var lineData = {
                    time: tt,
                    x: the_v,
                    m:''
                  };
                  lineArr[i].push(lineData);

                  if (lineArr[i].length > max_time_width_sec*signal_frequency_list[i]) {
                    lineArr[i].shift();

                  }
                }
                else
                {
                  break;
                }
              }

            }

          }
        
            
            var thtml="";
         

          
          //{"fields":{"SignalName":"Pleth                         ","SignalFrequency":"125       ","Tzero":"2021.01.16 16:01:40.504","Datapoints":{"0":0,"1":0,"2":0,"3":0,"4":0,"5":0,"6":0,"7":0,"8":0,"9":0,"10":0,"11":0,"12":0,"13":0,"14":0,"15":0,"16":0,"17":0,"18":0,"19":0,"20":0,"21":0,"22":0,"23":0,"24":0,"25":0,"26":0,"27":0,"28":0,"29":0,"30":0,"31":0},"Ending":"|||||"}}

         // socket.emit('reply','Hello Node JS');

      });
      }


   
function CsvUpload() {
  var fileUpload = document.getElementById("fileUpload");
  var regex = /^([a-zA-Z0-9\s_\\.\-:\(\)])+(.csv|.txt)$/;

  if (regex.test(fileUpload.value.toLowerCase())) {
    if (typeof (FileReader) != "undefined") {
          var reader = new FileReader();
          reader.onload = function (e) {
      

            var rows = e.target.result.split("\n");
            idx=0;
            chartCnt=0;
            lineArr=[];
            raw_signals=[];

            
            if(rows.length>8)
            {
              var cells=rows[1].split(",")
              if(cells.length>1)
              {
                patient_id=cells[0];
                patient_name=cells[1];
                if(cells.length>6)
                {

                  if(cells[2]!="")
                  {

                    if(!annotation_regions[0])
                      annotation_regions[0]={};
                    var t0_s=new Date();
                    var t0_e=new Date();
                    
                  t0_s.setTime(cells[2]);
                  t0_e.setTime(cells[3]);
                    annotation_regions[0].s=t0_s;
                    annotation_regions[0].e=t0_e;

                  }
                  else
                  {
                    annotation_regions[0]=null;
                  }
                  if(cells[4]!=""){
                    if(!annotation_regions[1])
                    annotation_regions[1]={};

                    var t1_s=new Date();
                     var t1_e=new Date();
                     t1_s.setTime(cells[4]);
                    t1_e.setTime(cells[5]);

                        
                    annotation_regions[1].s=t1_s;
                    annotation_regions[1].e=t1_e;

                  }
                  else
                  {
                    annotation_regions[1]=null;
                  }
                  if(cells[6]!=""){
                    if(!annotation_regions[2])
                      annotation_regions[2]={};
                    

                      var t2_s=new Date();
                      var t2_e=new Date();
                    
                      t2_s.setTime(cells[6]);
                      t2_e.setTime(cells[7]);
                          
                      annotation_regions[2].s=t2_s;
                      annotation_regions[2].e=t2_e;
                  }
                  else
                  {
                    annotation_regions[2]=null;
                  }
            

                }

             
              
                noise_data_ABP=[];
                noise_data_ICP=[];
                var cells=rows[3].split(",")  //ABP_ARTIFACT
                for(var i=1;i<cells.length;i+=2)
                {
                  if(cells[i+2])
                  {
                    noise_data_ABP[noise_data_ABP.length]=[cells[i],cells[i+1],cells[i+2]];
                  }
                }

                cells=rows[4].split(",")  //ICP_ARTIFACT
                for(var i=1;i<cells.length;i+=2)
                {
                  if(cells[i+2])
                  {
                    noise_data_ICP[noise_data_ICP.length]=[cells[i],cells[i+1],cells[i+2]];
                  }
                }

          
                var cells=rows[6].split(",")
                for(var i=0;i<cells.length;i+=3)
                {
                  if(cells[i+1])
                  {
                    lineArr[idx]=[];
                    raw_signals[idx]=cells[i+1];
                    idx++;
                    chartCnt++;
                  }
                }
           

                for (var i = 7; i < rows.length; i++) {
                  var cells = rows[i].split(",");
                  if (cells.length > 1) {
                      for (var j = 0; j < cells.length; j+=3) {
                        if(cells[j+1])
                        {
                            if(cells[j+1]!="-")
                            {
                              xtime=new Date();
                              xtime.setTime(cells[j]);

                              var lineData={};
                              lineData["time"]=xtime;
                              lineData["x"]=parseFloat(cells[j+1]);
                              lineData["m"]=cells[j+2];

                              lineArr[j/3][i-7]=lineData;
                            }
                          }
                      }
                  }
              }

  //              $("#chartlist").html("");
  //              parentId="chartlist";
  //              h=500;
                
  //              data_ABP_idx=findSignalIdxof("ABP");
  //              data_ICP_idx=findSignalIdxof("ICP");
              
                regions=[null,null,null];
                
                showOverviewChart();
//                drawOverviewChart(parentId,h,data_ABP_idx,data_ICP_idx,"ABP","ICP");
//                $(".show_for_overview").css("display","inline-block");
              }
            else
            {

              alert("this is a wrong type of csv file!");
            }
          }
        
        
          
        }
        reader.readAsText(fileUpload.files[0]);
      } else {
          alert("This browser does not support HTML5.");
      }
 }   else {
      alert("Please upload a valid CSV file.");
  }  
}






exportToCsv = function() {

      
var results = [];
if(lineArr.length<1)
  return;

results[0]=[];
results[0][0]="patient_id";
results[0][1]="patient_name";
results[0][2]="baseline_start";
results[0][3]="baseline_end";
results[0][4]="transient_start";
results[0][5]="transient_end";
results[0][6]="plateau_start";
results[0][7]="plateau_end";

results[1]=[];
results[1][0]=patient_id;
results[1][1]=patient_name;

console.log("annotation_regions");
console.log(annotation_regions);

if(annotation_regions[0])
{
  results[1][2]=annotation_regions[0].s.getTime();
  results[1][3]=annotation_regions[0].e.getTime();
}
else{
//  var t_s=new Date();
//  var t_e=new Date();
//  t_s.setTime(annotation_regions[0].s);
//  t_e.setTime(annotation_regions[0].e);
  results[1][2]="";
  results[1][3]="";
}

if(annotation_regions[1])
{
  results[1][4]=annotation_regions[1].s.getTime();
  results[1][5]=annotation_regions[1].e.getTime();
}
else{
  results[1][4]="";
  results[1][5]="";
}

if(annotation_regions[2])
{
  results[1][6]=annotation_regions[2].s.getTime();
  results[1][7]=annotation_regions[2].e.getTime();
}
else{
  results[1][6]="";
  results[1][7]="";
}


results[2]=[];

results[3]=[];
results[3][0]="artifact_ABP";
idx=1;
for(var i=0;i<noise_data_ABP.length;i++)
{
  results[3][idx]=noise_data_ABP[i][0];
  idx++;

  results[3][idx]=noise_data_ABP[i][1];
  idx++;

  results[3][idx]=noise_data_ABP[i][2];
  idx++;


}

results[4]=[];
results[4][0]="artifact_ICP";
idx=1;
for(var i=0;i<noise_data_ICP.length;i++)
{
  results[4][idx]=noise_data_ICP[i][0];
  idx++;

  results[4][idx]=noise_data_ICP[i][1];
  idx++;

  results[4][idx]=noise_data_ICP[i][2];
  idx++;
}



results[5]=[];


results[6]=[];
for(var j=0;j<raw_signals.length;j++) 
{
  results[6][j*3]="DateTime";
  results[6][j*3+1]=raw_signals[j];
  results[6][j*3+2]="Memo";
}

max_length=0;

for(var j=0;j<lineArr.length;j++)
{
  if(lineArr[j].length>max_length)
    max_length=lineArr[j].length;
}

for(var i=0;i<max_length;i++)
{
  results[i+7]=[];

  for(var j=0;j<lineArr.length;j++)
  {

    if(lineArr[j][i])
    {
      results[i+7][j*3]=lineArr[j][i].time.getTime();
      results[i+7][j*3+1]=lineArr[j][i].x;
      results[i+7][j*3+2]=lineArr[j][i].m;
    }
    else
    {
      results[i+7][j*3]="-";
      results[i+7][j*3+1]="-";
      results[i+7][j*3+2]="-";
    }
  }
}
//console.log(results);
  var CsvString = "";
  results.forEach(function(RowItem, RowIndex) {
    RowItem.forEach(function(ColItem, ColIndex) {
      CsvString += ColItem.toString().replace(/(?:\r\n|\r|\n)/g,'').replace(/,/gi,";") + ',';
    });
    CsvString += "\r\n";
  });
//  CsvString = "data:application/csv," + encodeURIComponent(CsvString);
 var x = document.createElement("A");

 var blob = new Blob(["\ufeff"+CsvString], {type: 'text/csv;charset=utf-8;'});
var url = URL.createObjectURL(blob);
var filename=getBaseFileName();
 x.setAttribute("href", url );
 x.setAttribute("download",filename+".csv");
 document.body.appendChild(x);
 x.click();
}



exportResultToCsv = function() {

      
var results = [];

results[0]=[];
results[0][0]="resistance_of_shunt";
results[0][1]=resistance_of_shunt;

results[1]=[];
results[1][0]="shunt_operating_pressure";
results[1][1]=shunt_operating_pressure;

results[2]=[];
results[2][0]="infusion_start";
results[2][1]=infusion_start;


results[3]=[];
results[3][0]="infusion_duration";
results[3][1]=infusion_duration;


results[4]=[];
results[4][0]="infusion_rate";
results[4][1]=infusion_rate;


results[5]=[];
results[5][0]="baseline_mean_ICP";
results[5][1]=baseline_mean_ICP;


results[6]=[];
results[6][0]="baseline_mean_AMP";
results[6][1]=baseline_mean_AMP;


results[7]=[];
results[7][0]="plateau_mean_ICP";
results[7][1]=plateau_mean_ICP;


results[8]=[];
results[8][0]="plateau_mean_AMP";
results[8][1]=plateau_mean_AMP;


results[9]=[];
results[9][0]="Rcsf";
results[9][1]=Rcsf;


results[10]=[];
results[10][0]="Pss";
results[10][1]=Pss;



results[11]=[];
results[11][0]="csf_production_rate";
results[11][1]=csf_production_rate;


results[12]=[];
results[12][0]="infused_volume";
results[12][1]=infused_volume;


results[13]=[];
results[13][0]="elasticity";
results[13][1]=elasticity;


results[14]=[];
results[14][0]="PVI";
results[14][1]=PVI;




  var CsvString = "";
  results.forEach(function(RowItem, RowIndex) {
    RowItem.forEach(function(ColItem, ColIndex) {
      CsvString += ColItem.toString().replace(/(?:\r\n|\r|\n)/g,'').replace(/,/gi,";") + ',';
    });
    CsvString += "\r\n";
  });
//  CsvString = "data:application/csv," + encodeURIComponent(CsvString);
 var x = document.createElement("A");

 var blob = new Blob(["\ufeff"+CsvString], {type: 'text/csv;charset=utf-8;'});
var url = URL.createObjectURL(blob);

 x.setAttribute("href", url );
 x.setAttribute("download",getBaseFileName()+"_resultdata.csv");
 document.body.appendChild(x);
 x.click();
}
function getBaseFileName(){
  var filename="";
  if(patient_name!="")
    filename=filename+patient_name+"_";
  else
    filename=filename+"noname_";

  data_ABP_idx=findSignalIdxof("ABP");

  var date_format_str="";
  var d=new Date();
  date_format_str = d.getFullYear().toString()+((d.getMonth()+1).toString().length==2?(d.getMonth()+1).toString():"0"+(d.getMonth()+1).toString())+(d.getDate().toString().length==2?d.getDate().toString():"0"+d.getDate().toString())+(d.getHours().toString().length==2?d.getHours().toString():"0"+d.getHours().toString())+((parseInt(d.getSeconds()/5)*5).toString().length==2?(parseInt(d.getSeconds()/5)*5).toString():"0"+(parseInt(d.getSeconds()/5)*5).toString());
  if(lineArr[data_ABP_idx])
  {
    if(lineArr[data_ABP_idx][0])
    {
        d=lineArr[data_ABP_idx][0].time;
        date_format_str = d.getFullYear().toString()+((d.getMonth()+1).toString().length==2?(d.getMonth()+1).toString():"0"+(d.getMonth()+1).toString())+(d.getDate().toString().length==2?d.getDate().toString():"0"+d.getDate().toString())+(d.getHours().toString().length==2?d.getHours().toString():"0"+d.getHours().toString())+((parseInt(d.getSeconds()/5)*5).toString().length==2?(parseInt(d.getSeconds()/5)*5).toString():"0"+(parseInt(d.getSeconds()/5)*5).toString());
    }
  }
  filename=filename+date_format_str;

  return filename;

}
function showInputParamPopup()
{
resultErrorCnt=0;
  $("#modal_input_param_popup").modal("show");

}

var cur_data_idx_for_memo=-1;
var cur_time_idx_for_memo=-1;

function showMemoPopup(dataIdx,time_idx)
{
 
  cur_data_idx_for_memo=dataIdx;
  cur_time_idx_for_memo=time_idx;
  cur_memo=lineArr[cur_data_idx_for_memo][cur_time_idx_for_memo].m;
  if(cur_memo)
  {
    $("#memo").val(cur_memo);
    $("#btn_memo_delete").show();
  }
  else
  {
    $("#memo").val("");
    $("#btn_memo_delete").hide();
  }
  $("#modal_memo_popup").modal("show");
}
function deleteMemo()
{
  if(confirm("Do you want to delete this memo?"))
  {

    if(cur_data_idx_for_memo>-1)
    {
      lineArr[cur_data_idx_for_memo][cur_time_idx_for_memo].m="";

      const svg = d3.select("#"+parentId+" svg");
      
      svg.select("#memo_"+cur_data_idx_for_memo+"_"+cur_time_idx_for_memo).remove();
      cur_data_idx_for_memo=-1;
      cur_time_idx_for_memo=-1;
    }
  }

}
function finishMemoWriting()
{
  memo_v=$("#memo").val();
  var is_new=true;
  if(lineArr[cur_data_idx_for_memo][cur_time_idx_for_memo].m)
  is_new=false;

  lineArr[cur_data_idx_for_memo][cur_time_idx_for_memo].m=memo_v;

  parentId="chartlist";
  const svg = d3.select("#"+parentId+" svg");
  
  const t_memo_time=lineArr[cur_data_idx_for_memo][cur_time_idx_for_memo].time;

  console.log("cur_data_idx_for_memo:"+cur_data_idx_for_memo+",cur_time_idx_for_memo:"+cur_time_idx_for_memo);
  console.log(t_memo_time);
  


 

  cur_data_idx_for_memo=-1;
  cur_time_idx_for_memo=-1;
}
function record_stop()
{
    
  


    var action_key=$("#btn_record").text();
    
    if(action_key=="Record")
    {
    
      finishArtifactJob();
  
      getPatientData();
      var thtml='<div style="padding:150px 50px;text-align:center;font-size:30pt;color:#c0c0c0">No Signal </div>';
      $("#chartlist").html(thtml);
        $("#modal_signal_list").modal("show");
        $(".hide_for_overview").css("display","inline-block");
        $(".hide_for_artifactjob").css("display","none");

        
    }
    else
    {
        
        $(".hide_for_overview").css("display","none");

        clearBackGroundJob();
        $("#btn_record").html('Record');
          d3.selectAll("g.axis.y").interrupt();
          d3.selectAll("defs clipPath rect").interrupt();
          d3.selectAll("g path.data").interrupt();
              
    }
}
function clearBackGroundJobWithOutSocket()
{
  if(update_timer)
      clearInterval(update_timer);
  if(upload_timer)
    clearInterval(upload_timer);

    for(var i=0;i<raw_signals.length;i++)
    {

      var pid=calc_chart_update_timerId_list[raw_signals[i]];
      if(pid)
        clearInterval(pid);
      
    }


}
function clearBackGroundJob()
{
  clearBackGroundJobWithOutSocket();
  unloadSocket();

}
function addAIChart()
{
 // http://localhost:8001/

  t_signal_name="PPG2ABP"
  raw_signals.push(t_signal_name);

chartCnt=raw_signals.length;
t_idx=chartCnt-1;

lineArr[t_idx]=[];
graph_width_sec[t_idx]=GRAPH_WIDTH_SEC_DEFAULT;
lineArr_display[t_idx]=[];
signal_frequency_list[t_idx]=125;
thtml="";
thtml+='<div id="additional_chart_container_'+t_signal_name+'" class="additional_chart_container">';
thtml+='<div style="text-align:right"><select name="graph_width" id="graph_width" onchange="graph_width_change('+i+',this.value)"><option value="5">5SEC</option><option value="10" selected>10SEC</option><option value="30">30SEC</option><option value="60">1 min</option><option value="300">5 min</option></select></div>';
thtml+="<h2>"+t_signal_name+"</h2>";
thtml+='<div id="chart'+t_idx.toString()+'"></div>';
thtml+="<hr/></div>";


chart[t_idx]=getRealTimeChart();



calc_chart_update_timerId_list[t_signal_name] = setInterval(calc_chart_update.bind(null,t_idx,t_signal_name),8000);
$("#chartlist_analyze").append(thtml);
  

}

function addMemoNow()
{

  if(lineArr.length==0)
  {
      alert("No Signal is Recording!");

  }
  else{

    var time_idx=lineArr[0].length-1;
  
    showMemoPopup(0,time_idx);


  }

}

  </script>
  
  <div class="page-wrapper">
    <div class="page-inner">
       
        <aside class="page-sidebar"></aside>
        <div class="page-content-wrapper">
            <header class="page-header" role="banner">


            </header>
            <main id="js-page-content" role="main" class="page-content"style="">
              <div class="subheader" style="position:relative">

                
              <button class="btn btn-primary btn-pills" onclick="record_stop()" id="btn_record">Record</button>
              <button id="btn_load" class="btn btn-secondary btn-pills" style="margin-left:20px;" onclick="showLoadModal()">Load</button>
              <button id="btn_export" class="btn btn-secondary btn-pills" style="position:absolute;right:10px;" onclick="exportAll()">Export</button>  


              </div>
               <div style="width:100%;margin-bottom:10px;">
                <button  onclick="if(confirm('Do you want to start infusion study?')){showOverviewChart()}"  class="btn btn-primary hide_for_overview" style="width:300px;display:none" >Start Infusion Study</button>
             <!--
                <button  onclick="addAIChart()"  class="btn btn-secondary hide_for_overview" style="width:200px;display:none" >Add PPG2ABP Chart</button>
            --> 
                  <button  onclick="addMemoNow()"  class="btn btn-secondary hide_for_overview" style="float:right;width:150px;display:none" >Add Memo</button>


              
                  <div class="show_for_artifactjob" style="display:none;">
                    <button  onclick="finishArtifactJob()"   class="btn btn-primary" style="width:300px;" >Hide Artifact Tool</button>

                    <button  onclick="addNoiseArea('ABP')"  class="btn btn-secondary show_for_overview" style="float:right;width:150px;display:none;margin-left:10px;" >Add ABP Artifact</button>
                    <button  onclick="addNoiseArea('ICP')"  class="btn btn-secondary show_for_overview" style="float:right;width:150px;display:none;margin-left:10px;" >Add ICP Artifact</button>
                </div>
                  <div class="hide_for_artifactjob show_for_overview" style="display:none;">
                      <button  onclick="showInputParamPopup()"  class="btn btn-primary " style="width:150px;" >Analyze!</button>

                      <button  onclick="startArtifactJob()"  class="btn btn-secondary " style="float:right;width:150px;margin-left:10px;" >Show Artifact Tool</button>
                      <button  onclick="uploadSignals()"  class="btn btn-secondary " style="float:right;width:150px;margin-left:10px;" >Upload Signals</button>

                      
                  </div>
                </div>
                <div id="chartlist">
                        <div style="padding:150px 50px;text-align:center;font-size:30pt;color:#c0c0c0">No Signal </div>
                        

                </div>

            </main>
                      
          <div class="page-content-overlay" data-action="toggle" data-class="mobile-nav-on"></div> 
          <footer class="page-footer" role="contentinfo">
          </footer>
        </div>
      </div>
    </div>
    <script src="/js/vendors.bundle.js"></script>
    <script src="/js/app.bundle.js"></script>
    <script>
        function show_analyze_signal()
        {
         $("#modal_analyze_signal_list").modal("show");
        }
        
        </script>

        <script>
var calc_chart_update_timerId_list=[];
function finishAnalyzeSelectSignal()
{

  //remove previous additional chart and clear
      

            //draw Chart
      currentState="2_LIVE_SIGNAL";
        //chart 그리기
      thtml="";

      $('#modal_analyze_signal_list input').each(function() {

        if(this.checked==false)
        {
          t_signal_name=this.value;
          if($("#additional_chart_container_"+t_signal_name).length>0)
          {
            const t_idx=raw_signals.indexOf(t_signal_name);
            if(t_idx>=0)
            {
              clearInterval(calc_chart_update_timerId_list[t_signal_name]);
              chartCnt=chartCnt-1;
              chart.splice(t_idx,1);
              graph_width_sec.splice(t_idx,1);
              lineArr.splice(t_idx,1);
              signal_frequency_list.splice(t_idx,1);
              lineArr_display.splice(t_idx,1);
              $("#additional_chart_container_"+t_signal_name).remove();
            }

            

          }
        }
      });

      $('#modal_analyze_signal_list input:checked').each(function() {

          t_signal_name=this.value;
         
          if($("#additional_chart_container_"+t_signal_name).length>0)
          {}
          else
          {
           
              raw_signals.push(t_signal_name);

              chartCnt=raw_signals.length;
              t_idx=chartCnt-1;


              lineArr[t_idx]=[];
              if(t_signal_name=="PPG2ABP")
              {
                graph_width_sec[t_idx]=GRAPH_WIDTH_SEC_DEFAULT;
                signal_frequency_list[t_idx]=125;
              }
              else
              {
                graph_width_sec[t_idx]=ADDITIONAL_GRAPH_WIDTH_SEC_DEFAULT;
                signal_frequency_list[t_idx]=0.1;
              }

              lineArr_display[t_idx]=[];

             
              thtml+='<div id="additional_chart_container_'+t_signal_name+'" class="additional_chart_container">';
              thtml+='<div style="text-align:right"><select name="graph_width" id="graph_width" onchange="graph_width_change('+t_idx+',this.value)"><option value="60">1 min</option><option value="180">3min</option><option value="600">10 min</option><option value="1800">30 min</option></select></div>';
              thtml+="<h2>"+t_signal_name+"</h2>";
              thtml+='<div id="chart'+t_idx.toString()+'"></div>';
              thtml+="<hr/></div>";
              chart[t_idx]=getRealTimeChart();


              if(t_signal_name=="PPG2ABP")
                calc_chart_update_timerId_list[t_signal_name] =setInterval(calc_chart_update.bind(null,t_idx,t_signal_name),8000);
              else
                 calc_chart_update_timerId_list[t_signal_name] =setInterval(calc_chart_update.bind(null,t_idx,t_signal_name),10000);
  
          }

      });
     
      
      $("#chartlist_analyze").append(thtml);

      



}          
    function finishSelectSignal()
        {
          var signal_codes="";
          $('#modal_signal_list input:checked').each(function() {
            if(signal_codes=="")
              signal_codes=this.value;
            else
              signal_codes+=", "+this.value;
          });
          start_time=new Date();
          postAPI("/experiments/",{patient_id:patient_id,title:"new Exp",signal_codes:signal_codes,start_time:start_time},function(data){
              exp_id=data.id;

            

              clearBackGroundJobWithOutSocket();
              currentState="2_LIVE_SIGNAL";
                //draw Chart
                $("#chartlist").html('');
                raw_signals = [];
                DATASET = [];
                $('#modal_signal_list input:checked').each(function() {
                    raw_signals.push(this.value);
                });
                chartCnt=raw_signals.length;
                
                var thtml="";
                for(i=0;i<chartCnt;i++)
                {
              
                    lineArr[i]=[];
                    graph_width_sec[i]=GRAPH_WIDTH_SEC_DEFAULT;
                    thtml+='<div style="text-align:right"><select name="graph_width" id="graph_width" onchange="graph_width_change('+i+',this.value)"><option value="5">5SEC</option><option value="10" selected>10SEC</option><option value="30">30SEC</option><option value="60">1 min</option><option value="300">5 min</option></select></div>';

                    thtml+="<h2>"+raw_signals[i]+"</h2>";
                    thtml+='<div id="chart'+i+'"></div>';
                    thtml+="<hr/>";
                }
                if(chartCnt>0)
                {
                  thtml+='<div id="chartlist_analyze"></div>';
                  thtml+='<div onclick="show_analyze_signal()"  style="cursor:pointer;padding:25px 10px;font-size:40pt;border:1px dotted #c0c0c0;text-align:center;">+</div>';
                  
                }


                $("#chartlist").html(thtml);

                init_websocket();
                loadChartAndInitialize();
                update_timer=window.setInterval(updateData, 500);
                upload_timer=window.setInterval(uploadData, 4000);
                
                $("#btn_record").html('Stop');


          });



        }

</script>
<script>
      function unloadSocket(){
          if(socket)
                socket.disconnect(); 
        }

        function randomNumberBounds(min, max) {
          return Math.floor(Math.random() * max) + min;
        }
 
        

        function updateData() {
         
          
          for(i=0;i<chartCnt;i++)
          {

              if(lineArr[i].length>0)
              {
                var spoint=lineArr[i].length-1-graph_width_sec[i]*signal_frequency_list[i];
                if(spoint<0)
                  spoint=0;

                lineArr_display[i]=lineArr[i].slice(spoint,lineArr[i].length-1);            

                d3.select("#chart"+i).datum(lineArr_display[i]).call(chart[i]);
              }

          
          }
        }

        function findLastIndxBeforeTime(time_unix_ms,arr)
        {
          var rtn_v=0;
          for(i=arr.length-1;i>=0;i--)
          {
            if(arr[i].time.getTime()<time_unix_ms)
            {
              rtn_v=i;
              break;
            }
          }
          return rtn_v;
        }
        var last_upload_time=0;
        function getDataBetweenTimes(lt,ct,arr)
        {
          var over_lasttime_indx=0;
          var beforeorsame_curtime_indx=arr.length-1;

          for(var i=arr.length-1;i>=0;i--)
          {
            if(arr[i].time.getTime()>ct)
              beforeorsame_curtime_indx=i-1;
            
            over_lasttime_indx=i+1;


            if(arr[i].time.getTime()<=lt)
              break;

          }
          if(beforeorsame_curtime_indx==-1)
            beforeorsame_curtime_indx=0;

          return arr.slice(over_lasttime_indx,beforeorsame_curtime_indx);
        }
        function RemoveOldData(chart_idx)
        {

          var now = new Date();
          var t=now.getTime()-600000*4;//40분
          var idxForRemoveBeforeThisPosition=0;
          for(var i=(lineArr[chart_idx].length-1);i>=0;i--)
          {
            if(lineArr[chart_idx][i].time.getTime()<=t)
            {
              idxForRemoveBeforeThisPosition=i;
              break;
            }
          }
          if(idxForRemoveBeforeThisPosition>0){
            lineArr[chart_idx].splice(0,idxForRemoveBeforeThisPosition);
            console.log(raw_signals[chart_idx]+"| old part removed:from 0 to "+idxForRemoveBeforeThisPosition);
          }
           
         
          
        }
        function uploadData(){
          var now = new Date();
          current_upload_time=now.getTime()-60000;
          var upload_data=[];
          for(var i=0;i<chartCnt;i++)
          {

              if(lineArr[i].length>0)
              {
                var willBeUploadedDataArr=getDataBetweenTimes(last_upload_time,current_upload_time,lineArr[i]);
                console.log("willBeUploadedDataArr : ["+i+"]"+raw_signals[i] +" for "+last_upload_time+"~"+current_upload_time);
                if(raw_signals[i]=="PRx")
                  console.log(lineArr[i]);
                console.log(willBeUploadedDataArr);
                RemoveOldData(i);//10분 이상된 데이터는 삭제
//                last_indx=findLastIndxBeforeTime(last_upload_time,lineArr[i]);
//                cur_indx=findLastIndxBeforeTime(current_upload_time,lineArr[i]);
                
//                console.log(raw_signals[i]+"| last_indx:"+last_indx+"/cur_indx:"+cur_indx+"/");

                upload_data=upload_data.concat(willBeUploadedDataArr.map(function(obj){
                  var rObj = {};
                  rObj["exp_id"] = exp_id;
                  rObj["code"] = raw_signals[i];
                  rObj["time"] = obj.time.getTime();
                  rObj["v"] = obj.x;
                  rObj["memo"] =obj.m;
                  return rObj;
                }
                ));


              }
          }
          last_upload_time=current_upload_time;

          postAPI("/signals/",upload_data,function(data){
              console.log(data);
          });
          
          
          

        }

        function resize() {
            for(i=0;i<chartCnt;i++)
            {
                if (d3.select("#chart"+i+" svg").empty()) {
                    return;
              }
                chart[i].width(+d3.select("#chart"+i).style("width").replace(/(px)/g, ""));
                d3.select("#chart"+i).call(chart[i]);

            }
        }

        function loadChartAndInitialize()
        {

            for(i=0;i<chartCnt;i++)
            {
                chart[i]=getRealTimeChart();

            }
           




            
           // d3.select(window).on('resize', resize);
        }

        </script>
    <script>



    
      window.onload = function(){
        loadStructure();
        cur_url_param_arr=getLocation(location.href).search.split("&");
        if(cur_url_param_arr.length>0)
        {
          nv=cur_url_param_arr[0].replace("?","").split("=");
          if(nv[0]=="id")
          {
            exp_id=nv[1];
            loadFromDB(nv[1]);
          }
        }
       
      }
    </script>
<script>
var exp_id=-1;//가져오는 방식으로 변경필요!
var PatientData=[];
  function uploadSignals()
  {
    var idx=1;
    const ABP_idx=findSignalIdxof("ABP");
    const ICP_idx=findSignalIdxof("ICP");
    var signalData1=[];
    var signalData2=[];

    if(lineArr[ABP_idx])
    {
          signalData1=lineArr[ABP_idx].map(function(obj){
            var rObj = {};
            rObj["exp_id"] = exp_id;
            rObj["code"] = "ABP";
            rObj["time"] = obj.time.getTime();
            rObj["v"] = obj.x;
            rObj["memo"] =obj.m;
            return rObj;
          });
      }
      if(lineArr[ICP_idx])
      {

        signalData2=lineArr[ICP_idx].map(function(obj){
              var rObj = {};
              rObj["exp_id"] = exp_id;
              rObj["code"] = "ICP";
              rObj["time"] = obj.time.getTime();
              rObj["v"] = obj.x;
              rObj["memo"] =obj.m;
              return rObj;
            });

      }
          signalData=signalData1.concat(signalData2);
          //signalData=signalData.slice(0,1000);
          postAPI("/signals/",signalData,function(data){

         
          
          });
  




  }
  function getPatientData()
  {

    getAPI2("/patients/",{"skip":0,"limit":100},"GET",function(data){
      PatientData=[];
        thtml='';
      if(data){
        for(i=0;i<data.length;i++)
        {
          item=data[i];
          PatientData.push({id:item.id,name:item.name,gender:item.gender,age:item.age,weight:item.weight,height:item.height,patient_object:item.patient_object});

          thtml+='<option value="'+item.id+'">'+item.name+'('+item.id+')</option>';
          if(i==0)
          {
            patient_id=item.id;
            patient_name=item.name;

          }          
            
        }
      }
       
        $("#patient_id").html(thtml);

       
   
    });
  }
function select_patient(v)
{
  patient_id=v;
  for(i=0;i<PatientData.length;i++)
  {
    if(PatientData[i].id==patient_id)
    {
      patient_name=PatientData[i].name;
      break;
    }
  }
  
  

}




  function startArtifactJob()
  {
    $(".hide_for_artifactjob").css("display","none");
    $(".show_for_artifactjob").css("display","block");
    
    $(".region_handler").attr("opacity",0);
    $(".noise_handler").attr("opacity",1);
    $(".noise_handler_bg").attr("opacity",0.5);
    
    //현 차트 가운데 지점에 가상의 region 삭제
    //버튼 toggle

  }

  function finishArtifactJob()
  {
    $(".hide_for_artifactjob").css("display","block");
    $(".show_for_artifactjob").css("display","none");

    $(".region_handler").attr("opacity",1);
    $(".noise_handler").attr("opacity",0);
    //현 차트 가운데 지점에 가상의 region 삭제
     //버튼 toggle기

  }
function showLoadModal()
{
  $("#modal_load").modal("show");
}


(function() {

window.addEventListener("resize", resizeThrottler, false);

var resizeTimeout;
function resizeThrottler() {
  // ignore resize events as long as an actualResizeHandler execution is in the queue
  if ( !resizeTimeout ) {
    resizeTimeout = setTimeout(function() {
      resizeTimeout = null;
      actualResizeHandler();

     // The actualResizeHandler will execute at a rate of 15fps
     }, 777);
  }
}

function actualResizeHandler() {
console.log("resized!");
  resize();
}

}());

var skip_v=100;
function loadFromDB(id)
{
      idx=0;
      chartCnt=0;
      lineArr=[];
      raw_signals=[];
      annotation_regions=[];

    var result_json;
      getAPI_sync("/experiments/"+id,{},"GET",function(data){
        baseline_end=data.baseline_end;
        baseline_start=data.baseline_start;
        plateau_end=data.plateau_end;
        plateau_start=data.plateau_start;
        transient_end=data.transient_end;
        transient_start=data.transient_start;
        result_json=data.result_json;

if(baseline_start){
  if(!annotation_regions[0])
    annotation_regions[0]=[];


    var t_baseline_start=new Date();
          var t_baseline_end=new Date();

          t_baseline_start.setTime(baseline_start);
          t_baseline_end.setTime(baseline_end);

  annotation_regions[0].s=t_baseline_start;
  annotation_regions[0].e=t_baseline_end;

}
if(transient_start){
        if(!annotation_regions[1])
          annotation_regions[1]=[];

          var t_transient_start=new Date();
          var t_transient_end=new Date();

          t_transient_start.setTime(transient_start);
          t_transient_end.setTime(transient_end);

          annotation_regions[1].s=t_transient_start;
        annotation_regions[1].e=t_transient_end;
}
if(plateau_start){

  if(!annotation_regions[2])
          annotation_regions[2]=[];

          var t_plateau_start=new Date();
          var t_plateau_end=new Date();

          t_plateau_start.setTime(plateau_start);
          t_plateau_end.setTime(plateau_end);

          annotation_regions[2].s=t_plateau_start;
        annotation_regions[2].e=t_plateau_end;

}


  

   


 
      });
      noise_data_ABP=[];
        noise_data_ICP=[];
       getAPI_sync("/artifacts/"+id,{},"GET",function(data){
          

          for(var i=0;i<data.length;i++){

              if(data[i].code=="ABP")
              {
                noise_data_ABP[noise_data_ABP.length]=[data[i].serial,data[i].s_time,data[i].e_time];
              }
              
              if(data[i].code=="ICP")
              {
                noise_data_ICP[noise_data_ICP.length]=[data[i].serial,data[i].s_time,data[i].e_time];
              }
              
              

            }
        
       });
       getAPI_sync("/signals/"+id+"/ABP/lasttime",{},"GET",function(data){
          //console.log(data);
          lasttimeofchart=data;
       });
       
       getAPI_sync("/signals/"+id+"/ABP/firsttime",{},"GET",function(data){
          //console.log(data);
          firsttimeofchart=data;
       });

       skip_v=125*(lasttimeofchart-firsttimeofchart)/5000000;
       if(skip_v<1)
        skip_v=1;

        skip_v=parseInt(skip_v);
        console.log("skip_v:"+skip_v);
        //getAPI2("/signals/"+id,{time_s:lasttimeofchart-20*1*1000,time_e:lasttimeofchart},"GET",function(data){
          getAPI2("/signals/"+id,{time_s:firsttimeofchart,time_e:lasttimeofchart,skip_v:skip_v},"GET",function(data){
          ABP_cnt=0;
          ICP_cnt=0;

          ABP_idx=lineArr.length;
          lineArr[ABP_idx]=[];
          raw_signals[ABP_idx]="ABP";
          idx++;
          chartCnt++;

          ICP_idx=lineArr.length;
          lineArr[ICP_idx]=[];
          raw_signals[ICP_idx]="ICP";
          idx++;
          chartCnt++;


          for(var i=0;i<data.length;i++)
          {
              R=data[i];

              xtime=new Date();
              xtime.setTime(R.time);

              var lineData={};
              lineData["time"]=xtime;
              lineData["x"]=parseFloat(R.v);
              lineData["m"]=R.memo;


              if(R.code=="ABP")
              {
                lineArr[ABP_idx][ABP_cnt++]=lineData;
              }
              else if(R.code=="ICP")
              {

                lineArr[ICP_idx][ICP_cnt++]=lineData;
              }

          }

          patient_id=id;
        



          
       //     regions=[null,null,null];
     clearBackGroundJobWithOutSocket();
  currentState="3_OVERVIEW";

    $(".hide_for_overview").css("display","none");
   $(".show_for_overview").css("display","inline-block")
    $("#chartlist").html("");

    parentId="chartlist";
    h=500;
    
    data_ABP_idx=findSignalIdxof("ABP");
    data_ICP_idx=findSignalIdxof("ICP");
   console.log(noise_data_ABP);
   console.log(noise_data_ICP);
    drawOverviewChart(parentId,h,data_ABP_idx,data_ICP_idx,"ABP","ICP");

            drawInfusionResult(JSON.parse(result_json));
            });


}
</script>

<div class="modal fade" id="modal_load" tabindex="-1" role="dialog" aria-modal="true">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"> Data Import from CSV</h5>
        <button type="button" class="close modal-close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true"><i class="fal fa-times"></i></span>
        </button>
      </div>
      <div class="modal-body">
        <div class="panel list is-admin" style="padding:20px 10px">

        <div class="row">
          <div class="col-12"><input type="file" id="fileUpload" /></div>
      </div>
    </div>
      </div>
      <div class="modal-footer">
        
        <button type="button" id="upload"  onclick="CsvUpload()" class="btn  modal-close btn-primary waves-effect waves-themed" data-dismiss="modal">Import </button> 
        <button type="button" class="btn modal-close btn-secondary waves-effect waves-themed" data-dismiss="modal">Cancel</button>
      </div>
    </div>
  </div>
</div>



<div class="modal fade" id="modal_input_param_popup" tabindex="-1" role="dialog" aria-modal="true">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">input parameters</h5>
        <button type="button" class="close modal-close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true"><i class="fal fa-times"></i></span>
        </button>
      </div>
      <div class="modal-body">
        <div class="panel list is-admin" style="padding:20px 10px">
          <div class="row">
            <div class="col-6"><h5>resistance of shunt</h5></div>
            <div class="col-6"><input type="text" name="resistance_of_shunt" id="resistance_of_shunt"></div>
        </div>
        <div class="row">
          <div class="col-6"><h5>shunt operating pressure</h5></div>
          <div class="col-6"><input type="text" id="shunt_operating_pressure" name="shunt_operating_pressure"></div>
      </div>
        <div class="row">
          <div class="col-6"><h5>infusion start</h5></div>
          <div class="col-6"><input type="datetime-local" id="infusion_start" name="infusion_start"></div>
      </div>
      <div class="row">
        <div class="col-6"><h5>infusion duration</h5></div>
        <div class="col-6"><input type="text" id="infusion_duration" name="infusion_duration"></div>
    </div>
      <div class="row">
          <div class="col-6"><h5>infusion rate</h5></div>
          <div class="col-6"><input type="text" id="infusion_rate" name="infusion_rate"></div>
        </div>
 
        </div>
      </div>
      <div class="modal-footer">
               
          <button type="button" onclick="finishParamInput()" class="btn  modal-close btn-primary waves-effect waves-themed" data-dismiss="modal">Start</button> 
          <button type="button" class="btn modal-close btn-secondary waves-effect waves-themed" data-dismiss="modal">Cancel</button>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="modal_memo_popup" tabindex="-1" role="dialog" aria-modal="true">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Annotation</h5>
        <button type="button" class="close modal-close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true"><i class="fal fa-times"></i></span>
        </button>
      </div>
      <div class="modal-body">
        <div class="panel list is-admin" style="padding:20px 10px">

        <div class="row">
          <div class="col-12"><h5>Memo</h5></div>
      </div>
        <div class="row">
          <div class="col-12"><textarea name="memo" id="memo" rows="3" style="width:100%"></textarea></div>
      </div>

    </div>
      </div>
      <div class="modal-footer">
        
        <button type="button" onclick="finishMemoWriting()" class="btn  modal-close btn-primary waves-effect waves-themed" data-dismiss="modal">Save</button> 
        <button type="button" onclick="deleteMemo()" id="btn_memo_delete" class="btn  modal-close btn-secondary waves-effect waves-themed" data-dismiss="modal">Delete</button> 
        <button type="button" class="btn modal-close btn-secondary waves-effect waves-themed" data-dismiss="modal">Cancel</button>
      </div>
    </div>
  </div>
</div>


<div class="modal fade" id="modal_signal_list" tabindex="-1" role="dialog" aria-modal="true">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Initialize Experiment</h5>
          <button type="button" class="close modal-close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true"><i class="fal fa-times"></i></span>
          </button>
        </div>
  
        <div class="modal-body">
          <div class="panel list is-admin" style="padding:20px 10px">

            <h4>Select Patient </h4>
            <div >
              
              <select  style="border:1px solid #c0c0c0" class="form-control" id="patient_id" onchange="select_patient(this.value)"> <option value="">-환자선택-</option></select>
            </div>
    
            <hr>
            <h4>Select Raw Signals</h4>
              <div class="row">
                <div class="col-6">
                    <div class="signal_select_item">
                    <input type="checkbox" onclick="if(!this.checked){alert('this signal is always needed');this.checked=true;}" name="chk_signal" id="chk_signal_ABP" value="ABP" checked>
                      &nbsp;ABP
                    </div>
                </div>
                <div class="col-6">
                  <div class="signal_select_item">
                    <input type="checkbox" onclick="if(!this.checked){alert('this signal is always needed');this.checked=true;}" name="chk_signal" id="chk_signal_ICP" value="ICP" checked>
                    &nbsp;ICP
                  </div>
                </div>
                

              </div>

            <div class="row">
              <div class="col-6">
                <div class="signal_select_item">
                 <input type="checkbox"  name="chk_signal" id="chk_signal_EEG" value="EEG">
                 &nbsp;EEG
                </div>
              </div>
              <div class="col-6">
                <div class="signal_select_item">
                  <input type="checkbox"  name="chk_signal" id="chk_signal_SpO2" value="SpO2">
                  &nbsp;SpO2
                 </div>
              </div>
            </div>

            <div class="row">
              <div class="col-6">
                <div class="signal_select_item">
                 <input type="checkbox"  name="chk_signal" id="chk_signal_PPG" value="PPG">
                 &nbsp;PPG
                </div>
              </div>
              <div class="col-6">
                <div class="signal_select_item">
                  <input type="checkbox"  name="chk_signal" id="chk_signal_Pleth" value="Pleth">
                  &nbsp;Pleth
                 </div>
              </div>
            </div>

            <div class="row">
              <div class="col-6">
                <div class="signal_select_item">
                 <input type="checkbox"  name="chk_signal" id="chk_signal_ECG" value="ECG">
                 &nbsp;ECG
                </div>
              </div>
              <div class="col-6">
                <div class="signal_select_item">
                  <input type="checkbox"  name="chk_signal" id="chk_signal_Resp" value="Resp">
                  &nbsp;Resp
                 </div>
              </div>
            </div>

            <div class="row">
              <div class="col-6">
                <div class="signal_select_item">
                 <input type="checkbox"  name="chk_signal" id="chk_signal_III" value="III">
                 &nbsp;III
                </div>
              </div>
              <div class="col-6">
                <div class="signal_select_item">
                  <input type="checkbox"  name="chk_signal" id="chk_signal_II" value="II">
                  &nbsp;II
                 </div>
              </div>
            </div>
            


          
          </div>
        </div>
        <div class="modal-footer">
            
            <button type="button" onclick="finishSelectSignal()" class="btn  modal-close btn-primary btn-pills waves-effect waves-themed" data-dismiss="modal">Confirm</button> 
            <button type="button" class="btn modal-close btn-secondary btn-pills waves-effect waves-themed" data-dismiss="modal">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="modal_analyze_signal_list" tabindex="-1" role="dialog" aria-modal="true">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Select Additional Signals</h5>
        <button type="button" class="close modal-close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true"><i class="fal fa-times"></i></span>
        </button>
      </div>


      <div class="modal-body">
        <div class="panel list is-admin" style="padding:20px 10px">
          <h3  style="text-align: center;">Autoregulation</h3>
          <div class="row">
            <div class="col-1" style="text-align:right"><input type="checkbox" name="chk_signal" id="chk_signal_CPP" value="CPP"></div>
            <div class="col-5"><h5>CPP</h5></div>
            <div class="col-1" style="text-align:right"> <input type="checkbox" name="chk_signal" id="chk_signal_AMP" value="AMP"></div>
            <div class="col-5"><h5>AMP </h5></div>
          </div>

            <div class="row">
              <div class="col-1" style="text-align:right"><input type="checkbox" name="chk_signal" id="chk_signal_PRx" value="PRx"></div>
              <div class="col-5"><h5>PRx </h5></div>
              <div class="col-1" style="text-align:right"> <input type="checkbox" name="chk_signal" id="chk_signal_PAx" value="PAx"></div>
              <div class="col-5"><h5>PAx </h5></div>
          </div>

          <div class="row">
              <div class="col-1" style="text-align:right"><input type="checkbox" name="chk_signal" id="chk_signal_RAP" value="RAP"></div>
              <div class="col-5"><h5>RAP </h5></div>
              <div class="col-1" style="text-align:right"> <input type="checkbox" name="chk_signal" id="chk_signal_RAC" value="RAC"></div>
              <div class="col-5"><h5>RAC </h5></div>
          </div>

          <div class="row">
            <div class="col-1" style="text-align:right"><input type="checkbox" name="chk_signal" id="chk_signal_wICP" value="wICP"></div>
            <div class="col-5"><h5>wICP </h5></div>

        </div>


          <hr>
          <h3 style="text-align: center;">Heart rate variability</h3>
          <div class="row">
            <div class="col-1" style="text-align:right"> <input type="checkbox" name="chk_signal" id="chk_signal_MRR" value="MRR"></div>
            <div class="col-5"><h5>Mean RR-interval </h5></div>
            <div class="col-1" style="text-align:right"><input type="checkbox" name="chk_signal" id="chk_signal_HF" value="HF"></div>
            <div class="col-5"><h5>HF</h5></div>

        </div>

        <div class="row">
            <div class="col-1" style="text-align:right"><input type="checkbox" name="chk_signal" id="chk_signal_SDNN" value="SDNN"></div>
            <div class="col-5"><h5>SDNN </h5></div>
            <div class="col-1" style="text-align:right"> <input type="checkbox" name="chk_signal" id="chk_signal_RMSSD" value="RMSSD"></div>
            <div class="col-5"><h5>RMSSD</h5></div>
        </div>

        <div class="row">
            <div class="col-1" style="text-align:right"><input type="checkbox" name="chk_signal" id="chk_signal_pNN50" value="pNN50"></div>
            <div class="col-5"><h5>pNN50</h5></div>
            <div class="col-1" style="text-align:right"><input type="checkbox" name="chk_signal" id="chk_signal_pNN20" value="pNN20"></div>
            <div class="col-5"><h5>pNN20</h5></div>
          </div>

          <div class="row">
            <div class="col-1" style="text-align:right"><input type="checkbox" name="chk_signal" id="chk_signal_VLF" value="VLF"></div>
            <div class="col-5"><h5>VLF</h5></div>
            <div class="col-1" style="text-align:right"><input type="checkbox" name="chk_signal" id="chk_signal_LF" value="LF"></div>
            <div class="col-5"><h5>LF</h5></div>
          </div>

          <hr>
          <h3 style="text-align: center;">AI</h3>
          <div class="row">
            <div class="col-1" style="text-align:right"> <input type="checkbox" name="chk_signal" id="chk_signal_PPG2ABP" value="PPG2ABP"></div>
            <div class="col-5"><h5>PPG2ABP</h5></div>

        </div>

          
        </div>



      </div>
      <div class="modal-footer">
          
          <button type="button" onclick="finishAnalyzeSelectSignal()" class="btn  modal-close btn-primary waves-effect waves-themed" data-dismiss="modal">Confirm</button> 
          <button type="button" class="btn modal-close btn-secondary waves-effect waves-themed" data-dismiss="modal">Cancel</button>
      </div>
    </div>
  </div>
</div>


  </body>
</html>



  
    

    
    
               