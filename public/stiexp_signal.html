<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Infusion Test Analyzer</title>
    <meta name="description" content="Page Title" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no, user-scalable=no, minimal-ui"
    />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="msapplication-tap-highlight" content="no" />
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="/js/realtime_chart.js"></script>
      <script src="/js/overview_chart.js"></script>
    <!-- base css -->
    <link
      id="vendorsbundle"
      rel="stylesheet"
      media="screen, print"
      href="/css/vendors.bundle.css"
    />
    <link
      id="appbundle"
      rel="stylesheet"
      media="screen, print"
      href="/css/app.bundle.css"
    />
    <link id="mytheme" rel="stylesheet" media="screen, print" href="css/themes/cust-theme-4.css">
    <link
      id="myskin"
      rel="stylesheet"
      media="screen, print"
      href="/css/skins/skin-master.css"
    />
    <link
    id="myskin"
    rel="stylesheet"
    media="screen, print"
    href="/css/custom.css"
  />
    <!-- Place favicon.ico in the root directory -->
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="/img/favicon/apple-touch-icon.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="/img/favicon/favicon-32x32.png"
    />
    <link
      rel="mask-icon"
      href="/img/favicon/safari-pinned-tab.svg"
      color="#5bbad5"
    />
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script>
      const xt=new Date().getTime();
      let s = document.createElement('script');
      s.src = "/js/include.js?var" +xt;
      s.type = 'text/javascript';
      s.async = false;
      s.defer=true;
      let x = document.getElementsByTagName('script')[document.getElementsByTagName('script').length-1];
      x.parentNode.insertBefore(s, x);
    </script>


  </head>

  <body class="mod-skin-dark">
  
  <div class="page-wrapper">
    <div class="page-inner">
       
        <aside class="page-sidebar"></aside>
        <div class="page-content-wrapper">
            <header class="page-header" role="banner"></header>
            <main id="js-page-content" role="main" class="page-content">
                <div class="subheader">
                    <h2 class="subheader-title">
                      <i class="subheader-icon fal fa-circle"></i> Mornitoring
                    </h2>
                  </div>


                  <div class="panel list">
                    
                    <div class="panel-container">
                         <div class="panel-content poisition-relative">
         
         
                  
                  
                      <div style="float:left;width:65%;margin-right:5%">
                        <div id="toolbox1" style="display:none;">
                          <div style="float:left;width:30%;margin-right:5%"><a class="btn btn-block btn-secondary" href="javascript:addTrigger()">Trigger</a></div>
                          <div style="float:left;width:30%;margin-right:5%"><a class="btn btn-block btn-secondary" id="toggleSignal" href="javascript:toggleSignal()">Pause</a></div>
                          <div style="clear:both;"></div>
                        </div>

                        <div id="chartlist">
                          <div style="text-align:center;padding:100px 70px;">
                            <h4>블루투스 기기의 전원을 켜고 아래의 Connect 버튼을 눌러 기기를 연결해주세요.</h4>
                            <br><br>
                            <button class="btn btn-lg btn-primary" onclick="connectDevice()">Connect to Device</button>
                          </div>
                        </div>
                      </div>
                      <div style="float:left;width:30%;">
                        <div id="toolbox2" style="display:none;">
                          <div style="float:left;width:30%;margin-right:5%"><a class="btn btn-block btn-secondary" href="javascript:showSetting()">자극 설정</a></div>
                          <div style="float:left;width:30%;margin-right:5%"><a class="btn btn-block btn-secondary" href="javascript:showMarkerAdd()">Marker</a></div>
                          <div style="float:left;width:30%;"><a class="btn btn-block btn-primary" href="javascript:finish()">실험종료</a></div>
                          <div style="clear:both;"></div>
                        </div>
                        <div style="padding-top:15px;padding-bottom:10px;border-bottom:1px solid #fff;font-size:15pt">Event Marker List</div>
                        <div id="event_list">-</div>
                      </div>

                      <div style="clear:both;"></div>

            </div>
        </div>

        <div class="modal fade" id="modal_marker_popup" tabindex="-1" role="dialog" aria-modal="true">
          <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Marker 관리</h5>
                <button type="button" class="close modal-close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true"><i class="fal fa-times"></i></span>
                </button>
              </div>
              <div class="modal-body">
                <div class="panel list" style="padding:20px 10px">


                  
                        <div class="row" style="margin-top:0px;margin-bottom:10px;">
                          <div class="col-4"><h5>시간</h5></div>
                          <div class="col-8" id="marker_time"> 
                          </div>
                        </div>


                        <div class="row">
                          <div class="col-4"><h5>내용</h5></div>
                          <div class="col-8">
                              <textarea class="form-control" id="marker_desc">

                              </textarea>                            
                          </div>

                        </div>

    
                      
                      
                    
                  </div>
              </div>
              <div class="modal-footer">
                <button id="deleteMarker" type="button" onclick="deleteMarker()" class="btn btn-primary waves-effect waves-themed" style="display:none">삭제</button>      
                  <button type="button" onclick="mngMarkerAction()" class="btn btn-primary waves-effect waves-themed" >저장</button> 
                  <button type="button" class="btn modal-close btn-secondary waves-effect waves-themed" data-dismiss="modal">취소</button>
              </div>
            </div>
          </div>
        </div>


        <div class="modal fade" id="modal_setting_popup" tabindex="-1" role="dialog" aria-modal="true">
          <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">자극설정</h5>
                <button type="button" class="close modal-close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true"><i class="fal fa-times"></i></span>
                </button>
              </div>
              <div class="modal-body">
                <div class="panel list" style="padding:20px 10px">


                  <div class="row">
                      <div class="col-7">


                        <div class="row" style="margin-top:0px;margin-bottom:30px;">
                          <div class="col-3"><h5>Width   (uS)</h5></div>
                          <div class="col-7">
                            <input style="width:100%" id="sti_intensity_range" type="range" name="range" min="0" max="300" value="200" step="10" onchange="rangeChg('sti_intensity',this.value)">
                          </div>
                          <div class="col-2">
                            <input type="number" id="sti_intensity" name="intensity" style="width:100%"  value="200" onchange="rangenumChg('sti_intensity_range',this.value)">
                          </div>
                        </div>
                        
                        <div class="row" style="margin-bottom:30px;">
                          <div class="col-3"><h5>Duration (mS)</h5></div>
                          <div class="col-7">
                            <input style="width:100%" id="sti_interval_range" type="range" name="range" min="0" max="200" value="200" step="4" onchange="rangeChg('sti_interval',this.value)">
                          </div>
                          <div class="col-2">
                            <input type="number" id="sti_interval" name="interval" style="width:100%" value="200" onchange="rangenumChg('sti_interval_range',this.value)">
                          </div>
                        </div>

                        <div class="row">
                          <div class="col-3"><h5>Amplitude (mA)</h5></div>
                          <div class="col-7">
                            <input style="width:100%" id="sti_height_range" type="range" name="range" min="0" max="4095" value="4095" step="1" onchange="rangeChg('sti_height',this.value)">
                          </div>
                          <div class="col-2">
                            <input type="number" id="sti_height" name="height" style="width:100%" value="4095" onchange="rangenumChg('sti_height_range',this.value)">
                          </div>
                        </div>

    
                      </div>
                      <div class="col-5">
                          <h4>자극 목록</h4>
                          <div id="stimulus_list" style="border-top:1px solid #000;padding-top:0px;">
-
                          </div>

                      </div>
                    </div>
                  </div>
              </div>
              <div class="modal-footer">
                       
                  <button type="button" onclick="AddStimulus()" class="btn btn-primary waves-effect waves-themed" >설정</button> 
                  <button type="button" class="btn modal-close btn-secondary waves-effect waves-themed" data-dismiss="modal">취소</button>
              </div>
            </div>
          </div>
        </div>



            </main>
                      
          <div class="page-content-overlay" data-action="toggle" data-class="mobile-nav-on"></div> 
          <footer class="page-footer" role="contentinfo">
          </footer>
        </div>
      </div>
    </div>
    <script src="/js/vendors.bundle.js"></script>
    <script src="/js/app.bundle.js"></script>

<script>

var current_state="Pause";
function toggleSignal(){

  
 //   var x=$("#toggleSignal").html();
    if(current_state=="Pause")
    {
      current_state="Start";
      $("#toggleSignal").html("Pause");
    }
    else
    {
/*       d3.selectAll("g.axis.y").interrupt();
      d3.selectAll("defs clipPath rect").interrupt();
      d3.selectAll("g path.data").interrupt(); */
      current_state="Pause";
      $("#toggleSignal").html("Start");
    }
}
function rangeChg(id,v)
{
  $("#"+id).val(v);
}
function rangenumChg(id,v)
{  
  const max = $("#"+id).attr("max")

  if(v>Number(max))
  {
    alert("최대값을 벗어났습니다.");
    v=100;
    $("#"+id.replace("_range","")).val(v);
  }

  if(v<0)
  {
    alert("최소값은 0입니다.");
    v=0;
    $("#"+id.replace("_range","")).val(v);
  }
  $("#"+id).val(v);
  
}
function mngMarkerAction()
{
  
  var id=protocol_exp_id;
/*   var time_idx=lineArr[0].length-1;
  var t=lineArr[0][time_idx].time; */
  var obj={
    proto_exp_id:id,
    "memo": $("#marker_desc").val(),
    "time":mngMarkerAction_t,
    "regtime":mngMarkerAction_tdate.getTime()
  };

if(cur_marker_id)
{
  console.log(obj);
    patchAPI("/protocolExpsEvent/"+cur_marker_id,obj,function(data){
      alert("Updated!");
            loadAndDisplayTableEvent(1);
            $("#modal_marker_popup").modal("hide");
    });

}
else{
  console.log(obj);
    postAPI("/protocolExpsEvent/",obj,function(data){
      alert("Added!");
            loadAndDisplayTableEvent(1);
            $("#modal_marker_popup").modal("hide");
    });

}



}
var cur_marker_id=null;
var mngMarkerAction_tdate,mngMarkerAction_t;
function showMarkerAdd(t,tdate,txt,opt_id)
 {

  
   if(t)
   {
    $("#deleteMarker").show();
    mngMarkerAction_t=t;
    mngMarkerAction_tdate=new Date(tdate);
    ttxt=timetotxt(mngMarkerAction_tdate);

   }
   else{
    $("#deleteMarker").hide();

      var time_idx=lineArr[0].length-1;
      var t=lineArr[0][time_idx].time;
    
      mngMarkerAction_tdate=new Date();
      ttxt=timetotxt(mngMarkerAction_tdate);
      mngMarkerAction_t=t;
   }
  $("#marker_time").html(ttxt);
  
  cur_marker_id=opt_id;

  if(txt){}
  else{txt="";}

  $("#marker_desc").val(txt);
  $("#modal_marker_popup").modal("show");

 }
function showSetting()
{
  loadAndDisplayTable(1);
  $("#modal_setting_popup").modal("show");
  
}
function loadStimulusSetting()
{

}


const ADDITIONAL_GRAPH_WIDTH_SEC_DEFAULT=10;
const GRAPH_WIDTH_SEC_DEFAULT=10;

var  max_time_width_sec=60*30; //최대 저장시간 30분
var graph_width_sec=[];


var update_timer,upload_timer;
var lineArr = [];
var lineArr_display = [];
var signal_frequency_list=[];

var MAX_LENGTH = 100;
var duration = 500;
var chart=[] ;
//var raw_signals=[];
var chartCnt=0;
const signal_names=["EEG1","EEG2","PPG","X","Y","Z"];
const  raw_signals=signal_names;
var protocol_exp_id=null;
function init(){
  $("#toolbox1").show();
  $("#toolbox2").show();

  current_state="Start";

var thtml="";

  for(i=0;i<6;i++)
  {

      chart[i]=getRealTimeChart();
      lineArr[i]=[];
      graph_width_sec[i]=GRAPH_WIDTH_SEC_DEFAULT;
      lineArr_display[i]=[];
      signal_frequency_list[i]=50;
      
      thtml+='<div id="additional_chart_container_'+signal_names[i]+'" class="additional_chart_container">';
      thtml+='<div style="text-align:right"><select name="graph_width" id="graph_width" onchange="graph_width_change('+i+',this.value)"><option value="5">5SEC</option><option value="10" selected>10SEC</option><option value="30">30SEC</option><option value="60">1 min</option><option value="300">5 min</option></select></div>';
      thtml+="<h2>"+signal_names[i]+"</h2>";
      thtml+='<div id="chart'+i.toString()+'"></div>';
      thtml+="<hr/></div>";


  }
  $("#chartlist").html(thtml);
  update_timer=window.setInterval(updateData, 500);
  upload_timer=window.setInterval(uploadData, 4000);
  loadAndDisplayTableEvent(1);
}
function finish(){
  clearBackGroundJob();
  window.location="stiexp_result.html?id="+protocol_exp_id;
}
function clearBackGroundJob()
{
  if(update_timer)
      clearInterval(update_timer);
  if(upload_timer)
    clearInterval(upload_timer);

    /* for(var i=0;i<raw_signals.length;i++)
    {

      var pid=calc_chart_update_timerId_list[raw_signals[i]];
      if(pid)
        clearInterval(pid);
      
    }
 */

}
function findLastIndxBeforeTime(time_unix_ms,arr)
        {
          var rtn_v=0;
          for(i=arr.length-1;i>=0;i--)
          {
            if(arr[i].time.getTime()<time_unix_ms)
            {
              rtn_v=i;
              break;
            }
          }
          return rtn_v;
        }
        var last_upload_time=0;
        function getDataBetweenTimes(lt,ct,arr)
        {
           var over_lasttime_indx=0;
          var beforeorsame_curtime_indx=arr.length-1;

          for(var i=arr.length-1;i>=0;i--)
          {
            //if(arr[i].time.getTime()>ct)
            if(arr[i].time>ct)
              beforeorsame_curtime_indx=i-1;
            
            over_lasttime_indx=i+1;


            //if(arr[i].time.getTime()<=lt)
            if(arr[i].time<=lt)
              break;

          }
          if(beforeorsame_curtime_indx==-1)
            beforeorsame_curtime_indx=0;

          return arr.slice(over_lasttime_indx,beforeorsame_curtime_indx); 
      
        }
        function RemoveOldData(chart_idx)
        {
          
          var now = new Date();
          //var t=now.getTime()-600000*4;//40분
          var t=g_recv_idx-100000;
          var idxForRemoveBeforeThisPosition=0;
/*           for(var i=(lineArr[chart_idx].length-1);i>=0;i--)
          {
            if(lineArr[chart_idx][i].time.getTime()<=t)
            {
              idxForRemoveBeforeThisPosition=i;
              break;
            }
          }
 */

        for(var i=(lineArr[chart_idx].length-1);i>=0;i--)
          {
            if(lineArr[chart_idx][i].time<=t)
            {
              idxForRemoveBeforeThisPosition=i;
              break;
            }
          }


          idxForRemoveBeforeThisPosition
          if(idxForRemoveBeforeThisPosition>0){
            lineArr[chart_idx].splice(0,idxForRemoveBeforeThisPosition);
            console.log(raw_signals[chart_idx]+"| old part removed:from 0 to "+idxForRemoveBeforeThisPosition);
          }
           
         
          
        }
function uploadData(){

        var now = new Date();
          //current_upload_time=now.getTime()-60000;

          current_upload_time=g_recv_idx-5000;

          var upload_data=[];
          chartCnt=6;

          if(current_state!="Pause")
          {

            for(var i=0;i<chartCnt;i++)
            {

                if(lineArr[i].length>0)
                {
                  var willBeUploadedDataArr=getDataBetweenTimes(last_upload_time,current_upload_time,lineArr[i]);
                  console.log("willBeUploadedDataArr : ["+i+"]"+raw_signals[i] +" for "+last_upload_time+"~"+current_upload_time);
                
                  //console.log(willBeUploadedDataArr);
                  RemoveOldData(i);//10분 이상된 데이터는 삭제

                  upload_data=upload_data.concat(willBeUploadedDataArr.map(function(obj){
                    var rObj = {};
                    rObj["proto_exp_id"] = protocol_exp_id;
                    rObj["code"] = raw_signals[i];
                    //rObj["time"] = obj.time.getTime();
                    rObj["time"] = obj.time;
                    rObj["v"] = obj.x;
                  
                    return rObj;
                  }
                  ));


                }
            }
            last_upload_time=current_upload_time;
            //console.log(upload_data);
            postAPI("/protocolExpSignal/",upload_data,function(data){
                console.log(data);
            });
            
            
          }

        }

function updateData() {
         if(current_state=="Pause")
         {
    
            for(i=0;i<chart.length;i++)
            {

/*               d3.selectAll("g.axis.y").interrupt();
              d3.selectAll("defs clipPath rect").interrupt();
 */              d3.selectAll("#chart"+i+" path.data").interrupt();
                
            
            }
          
            return;
         }
          
         for(i=0;i<chart.length;i++)
         {

             if(lineArr[i].length>0)
             {
               var spoint=lineArr[i].length-1-graph_width_sec[i]*signal_frequency_list[i];
               if(spoint<0)
                 spoint=0;

               lineArr_display[i]=lineArr[i].slice(spoint,lineArr[i].length-1);            

               d3.select("#chart"+i).datum(lineArr_display[i]).call(chart[i]);
             }

         
         }
       }


function graph_width_change(idx,tw)
{
  graph_width_sec[idx]=tw;
}
function onDataRecv(t,eeg1,eeg2,ppg,x,y,z){
console.log(t);
  if(current_state!="Pause")
  {


    var tt=new Date();
/*     tt.setTime(t);
    tt.setMilliseconds(t%1000);
    
   
    console.log("T:"+t+"/"+tt+":"+tt);
    console.log(" tt.getMilliseconds():"+ tt.getMilliseconds());
 */    
tt=t;
 var lineData=[];
    lineData[0] = {time: tt,x: eeg1,m:''};
    lineData[1] = {time: tt,x: eeg2,m:''};
    lineData[2] = {time: tt,x: ppg,m:''};
    lineData[3] = {time: tt,x: x,m:''};
    lineData[4] = {time: tt,x: y,m:''};
    lineData[5] = {time: tt,x: z,m:''};
    
    for(var i=0;i<6;i++)
    {
      lineArr[i].push(lineData[i]);
      if (lineArr[i].length > max_time_width_sec*signal_frequency_list[i]) {
        lineArr[i].shift();
      }

    }
  }
}
var noise_data_ICP=[];
var noise_data_ABP=[];

  </script>


    <script>

DataView.prototype.getUint24 = function(pos) {
	return (this.getUint16(pos) << 8) + this.getUint8(pos+2);
}
DataView.prototype.getInt24 = function(pos) {
	return (this.getInt16(pos) << 8) + this.getUint8(pos+2);
}


      const    CURRENT_SERVICE_UUID="6e400001-b5a3-f393-e0a9-e50e24dcca9e";
      const NOTIFY_UUID="6e400003-b5a3-f393-e0a9-e50e24dcca9e";
      const WRITE_UUID="6e400002-b5a3-f393-e0a9-e50e24dcca9e";
      function anyDeviceFilter() {
          // This is the closest we can get for now to get all devices.
          // https://github.com/WebBluetoothCG/web-bluetooth/issues/234
          return Array.from('nN')
              .map(c => ({namePrefix: c}))
              .concat({name: ''});
        }
let options = {
      //acceptAllDevices: true,
      filters: [{services:[CURRENT_SERVICE_UUID]}],
       //       filters: anyDeviceFilter(),
              optionalServices: ['generic_access']
            
}


      window.onload = function(){
        loadStructure();
        cur_url_param_arr=getLocation(location.href).search.split("&");
        if(cur_url_param_arr.length>0)
        {
          nv=cur_url_param_arr[0].replace("?","").split("=");
          if(nv[0]=="id")
          {
            protocol_exp_id=nv[1];
            
          }
        }
//        connectDevice();
      }
     

      function ab2str(buf) {
  return String.fromCharCode.apply(null, new Uint16Array(buf));
}
function str2ab(str) {
  var buf = new ArrayBuffer(str.length*2); // 2 bytes for each char
  var bufView = new Uint16Array(buf);
  for (var i=0, strLen=str.length; i < strLen; i++) {
    bufView[i] = str.charCodeAt(i);
  }
  return buf;
}
function intFromBytes( x ){
    var val = 0;
    for (var i = 0; i < x.length; ++i) {        
        val += x[i];        
        if (i < x.length-1) {
            val = val << 8;
        }
    }
    return val;
}
function getUint24(bytes,idx) {     
    var newInt = (  
     ((bytes.getUint8(0+idx)) *256*256) +  
     (( bytes.getUint8(1+idx)) *256) +  
     ( bytes.getUint8(2+idx))  
    );  

     if ((newInt & 0x008000000000000000000000) > 0) {
      newInt |= 0xFF0000000000000000000000;
					} else {
						newInt &= 0x00FFFFFFFFFFFFFFFFFFFFFF;
					} 
    
    return newInt;  
}  


function getUint16(bytes,idx) {     
    var newInt = (  
     (( bytes.getUint8(0+idx)) *8) +  
     ( bytes.getUint8(1+idx))  
    );  

    if ((newInt & 0x00800000) > 0) {
      newInt |= 0xFF000000;
					} else {
						newInt &= 0x00FFFFFF;
					}
    
    return newInt;  
}  
var pt;
var bluetoothService=null;
var g_recv_idx=0;
function connectDevice(){


  
  


    navigator.bluetooth.requestDevice(options).then(function(device) {
    console.log('Name: ' + device.name);
    console.log('Connecting to GATT Server...');
    // Do something with the device.
    wbdevice = device;
    return wbdevice.gatt.connect()
                .then(function (server) {

                  init();


                  console.log("server");console.log(server);
                    // Getting primary service from device with passed uuid
                    return server.getPrimaryService(CURRENT_SERVICE_UUID)
                        .then(function (service) {
                          console.log("service");console.log(service);
                            // Getting characteristic from service with passed uuid
                            bluetoothService=service;
                            service.getCharacteristic(WRITE_UUID).then(function (characteristic) {
                              console.log("characteristic1");console.log(characteristic);
                              deviceChar = characteristic;
                              const cmd="910|2";
                              
                              var uint8array = new TextEncoder().encode(cmd);

                              //deviceChar.writeValueWithResponse(str2ab(cmd)).then(function() { 
                                deviceChar.writeValueWithoutResponse(uint8array).then(function() { 
                                
                                console.log("wrote!!!!!!");
                              /*   deviceChar.readValue().then(function(dataView) { 
                                  console.log(ab2str(dataView));

                                 }); */
                                
                              })
                            });
                            
                            return service.getCharacteristic(NOTIFY_UUID)
                                .then(function (characteristic) {
                                  console.log("characteristic2");console.log(characteristic);

                                    // Storing in global variable
                                    deviceChar = characteristic;
                                    // Starting notifications on characteristic
                                    return characteristic.startNotifications()
                                        .then(function () {
                                          console.log("startNotifications");
                                          g_recv_idx=0;
                                            // Listening for event
                                            characteristic.addEventListener('characteristicvaluechanged', function (event) {
                                           //   console.log("characteristicvaluechanged");
                                              var xxx=new Date();
                                              //ct=xxx.getTime();
                                              //g_recv_idx=g_recv_idx+5;
                                              ct=g_recv_idx+1;
                                              
                                              
                                                if(pt)
                                                {
                                                    DATA=[];
                                                    DATA[0]=event.target.value.buffer.slice(0,33-1);
                                                    DATA[1]=event.target.value.buffer.slice(33,66-1);
                                                    DATA[2]=event.target.value.buffer.slice(66,99-1);
                                                    DATA[3]=event.target.value.buffer.slice(99,132-1);
                                                    DATA[4]=event.target.value.buffer.slice(132,165-1);
                                                   // var time_span=(ct-pt)/5;
                                                    var B9_11_PPG_avg=0;
                                                    for(i=0;i<DATA.length;i++)
                                                    
                                                    {
                                                      
                                                      //var t=pt+time_span*i;
                                                   var t=g_recv_idx++;
                                                      var td=new DataView(DATA[i]);

                                                      
                                                      let u8arr = new Uint8Array([td.getUint8(0), td.getUint8(1), td.getUint8(2), td.getUint8(3),td.getUint8(4),td.getUint8(5),td.getUint8(6),td.getUint8(7),td.getUint8(8),td.getUint8(9),td.getUint8(10),td.getUint8(11),td.getUint8(12),td.getUint8(13),td.getUint8(14),td.getUint8(15),td.getUint8(16),td.getUint8(17),td.getUint8(18),td.getUint8(19),td.getUint8(20),td.getUint8(21),td.getUint8(22),td.getUint8(23),td.getUint8(24),td.getUint8(25),td.getUint8(26),td.getUint8(27),td.getUint8(28),td.getUint8(29),td.getUint8(30),td.getUint8(31)]);

                                                      B1=td.getUint8(0);
                                                      B2_SAMPLENUM=td.getUint8(1);
                                                      

   
      //                                                 B3_5_EEG1=(td.getUint8(2)<< 16) +(td.getUint8(3)<< 8) + td.getInt8(4);
                                                      //B3_5_EEG1=getUint24(td,2);
/*                                                       B3_5_EEG1=getUint24(td,2);
                                                      B6_8_EEG2=getUint24(td,5);
                                                      B9_11_PPG=getUint24(td,8);
 */

                                                      B3_5_EEG1=td.getInt24(2);
                                                      B6_8_EEG2=td.getInt24(5);
                                                      B9_11_PPG=td.getInt24(8);
                                                      B9_11_PPG_avg+=B9_11_PPG;

                                                      //B9_11_PPGX=(td.getUint8(8)<< 16) +(td.getUint8(9)<< 8) + td.getUint8(10);

                             /*                           console.log("--------"+B2_SAMPLENUM+"--------"); 
                                                      
                                                      console.log("B9_11_PPG:"+B9_11_PPG); */
/*                                                      
                                                      console.log("B9_11_PPGX:"+B9_11_PPGX);
                                                      
                                                      console.log("------------------");  */

                                                      B27_28_X=td.getUint16(26);
                                                      B29_30_Y=td.getUint16(28);
                                                      B31_32_Z=td.getUint16(30);

                                                   
                                                    
                                 
                                                      
                                                      
                                                      //B27_28_X=getUint16(td,26);
                                                      //B29_30_Y=getUint16(td,28);
                                                      //B31_32_Z=getUint16(td,30);
                                                        /* 
                                                      console.log("------------------"); 
                                                      console.log((td.getInt8(2)));
                                                      console.log((td.getInt8(2)<< 16));
                                                      console.log("------------------"); 
                                                      console.log((td.getUint8(3)));
                                                      console.log((td.getUint8(3)<< 8));
                                                      console.log("------------------"); 
                                                      console.log(td.getUint8(4));
                                                      console.log("B3_5_EEG1"); 
                                                      console.log(B3_5_EEG1);
                                                      console.log("------------------"); 
      */
                                                      // console.log(B2_SAMPLENUM+":"+B3_5_EEG1+","+B6_8_EEG2+","+B9_11_PPG+"|"+B27_28_X+"-"+B29_30_Y+"-"+B31_32_Z); 
                                                    
//onDataRecv(t, B3_5_EEG1,B6_8_EEG2,B9_11_PPG,B27_28_X,B29_30_Y,B31_32_Z);
                                                    
                                                  }
                                                  onDataRecv(t, B3_5_EEG1,B6_8_EEG2,parseInt(B9_11_PPG_avg/DATA.length),B27_28_X,B29_30_Y,B31_32_Z);
                                                }
                                                pt=ct;

                                                

                                                

                                               // var readoutValue = parseCharacteristicValue(readoutBuffer);
                                              //  console.log(readoutValue);
                                            });
                                        });
                                })
                        })
                 })
            // Error handling
           
  })
  .catch(function(error) {
    console.log("Something went wrong. " + error);
  });

/*   navigator.bluetooth.requestDevice(options)
        .then(function(device) {
            console.log('> Found ' + device.name);
            console.log('Connecting to GATT Server...');
            wbdevice = device;
            // Connecting on device
            return wbdevice.gatt.connect()
                .then(function (server) {
                    // Getting primary service from device with passed uuid
                    return server.getPrimaryService(CURRENT_SERVICE_UUID)
                        .then(function (service) {
                            // Getting characteristic from service with passed uuid
                            return service.getCharacteristic(CURRENT_UUID)
                                .then(function (characteristic) {
                                    // Storing in global variable
                                    deviceChar = characteristic;
                                    // Starting notifications on characteristic
                                    return characteristic.startNotifications()
                                        .then(function () {
                                            // Listening for event
                                            characteristic.addEventListener('characteristicvaluechanged', function (event) {
                                                var readoutBuffer = event.target.value.buffer;
                                                // Parsing readout data
                                                var readoutValue = parseCharacteristicValue(readoutBuffer);
                                                console.log(readoutValue);
                                            });
                                        });
                                })
                        })
                 })
            // Error handling
            }).catch(onError);
              */
}
     
      
function updatePagesize(ps)
{
        curpagesize=ps;
        loadAndDisplayTable(1);
}

function resetSearch()
{
        $("#search_searchKeyword").val('');
        loadAndDisplayTable(1);
}
var pageNumber=1;
function loadAndDisplayTableEvent(page)
{
  
  var search=null;
    var searchParameter=null;

    var orderParameter='dateTime';
    var order='DESC';

    startDateTime=null
    endDateTime=null

    pageNumber=page;
    count=130;   //pagesize

 

    obj={"search":search,"searchParameter":searchParameter,"orderParameter":orderParameter,"order":order,"pageNumber":pageNumber,"count":count};
    //obj={"pageNumber":pageNumber,"count":count};
    //obj = Object.assign(params,obj);


    getAPI2("/protocolExpsEvent/"+protocol_exp_id,{},"GET",function(data){



    


      thtml='';
      if(data){
        pageStartIdx=0;
        pageEndIdxPlus=data.length;
        if(page>0)
        {
          pageStartIdx=count*(page-1);
          pageEndIdxPlus=pageStartIdx+count;
        }
        if(pageEndIdxPlus>data.length)
          pageEndIdxPlus=data.length;

        for(i=pageStartIdx;i<pageEndIdxPlus;i++)
        {
            
            var item=data[i];
            var tdate=new Date();
            tdate.setTime(item.regtime);
            
              thtml+='<div style="padding:5px 0px">';
              thtml+='<div>'+timetotxt(tdate)+'&nbsp;&nbsp;<a href="javascript:showMarkerAdd(\''+item.time+'\',\''+timestamp(tdate)+'\',\''+item.memo+'\', '+item.serial+')"><i class="fal fa-search"></i></a></div>';
              thtml+='</div>';

        }
      }else
        {
          thtml+='<div class="panel">No Items.</div>';
        }
        $("#event_list").html(thtml);
/*         var pagingHTML=getPagingHTML(page,count,data.length,"loadAndDisplayTable");
        $("#pagination_listTable").html(pagingHTML); */

    });

}
function loadAndDisplayTable(page)
{
    
/*     if(!params)
        params=last_params;
 */

    var search=null;
    var searchParameter=null;

    var orderParameter='dateTime';
    var order='DESC';

    startDateTime=null
    endDateTime=null

    pageNumber=page;
    count=130;   //pagesize

    search_searchKeyword=$("#search_searchKeyword").val();
    if(search_searchKeyword!="")
    {
        search=search_searchKeyword;
        searchParameter=$("#search_searchParameter").val();
    }


    obj={"search":search,"searchParameter":searchParameter,"orderParameter":orderParameter,"order":order,"pageNumber":pageNumber,"count":count};
    //obj={"pageNumber":pageNumber,"count":count};
    //obj = Object.assign(params,obj);


    getAPI2("/protocolExpStimulus/"+protocol_exp_id,{},"GET",function(data){



    


      thtml='';
      if(data){
        pageStartIdx=0;
        pageEndIdxPlus=data.length;
        if(page>0)
        {
          pageStartIdx=count*(page-1);
          pageEndIdxPlus=pageStartIdx+count;
        }
        if(pageEndIdxPlus>data.length)
          pageEndIdxPlus=data.length;

        for(i=pageStartIdx;i<pageEndIdxPlus;i++)
        {
            
            var item=data[i];
            var tdate=timestamp(item.regdate);
            
            
              thtml+='<div style="padding:5px 0px 10px 0px;border-bottom:1px solid #000;">';
              thtml+='<div style="padding:3px 0px">'+tdate+'  </div>';
              thtml+='<div  style="padding:3px 0px">세기 : '+item.intensity+' / 간격 : '+item.interval+' / 높이: '+item.height+'</div>';
              thtml+='<a href="javascript:setStimulus('+item.intensity+','+item.interval+','+item.height+')" class="btn btn-xs btn-primary">선택</a>';
              thtml+='</div>';

        }
      }else
        {
          thtml+='<div style="padding:15px 0px">No Items.</div>';
        }
        $("#stimulus_list").html(thtml);
/*         var pagingHTML=getPagingHTML(page,count,data.length,"loadAndDisplayTable");
        $("#pagination_listTable").html(pagingHTML); */

    });


}
function timestamp(t){ var td = new Date(t); td.setHours(td.getHours() + 9); return td.toISOString().replace('T', ' ').substring(0, 19); }


function setStimulus(intensity,interval,height){

  $("#sti_intensity").val(intensity);
  $("#sti_interval").val(interval);
  $("#sti_height").val(height);

  $("#sti_intensity_range").val(intensity);
  $("#sti_interval_range").val(interval);
  $("#sti_height_range").val(height);
}

//var cur_mode="modify";

function  showDetail(id)
{
  
 window.location="signals.html?id="+id;

}


function removeItem(code)
{
    
     
  obj={"id":code};
      
      getAPI2("/experiments/"+code+"/",obj,"DELETE",function(data){
              alert("deleted!");
              loadAndDisplayTable(pageNumber);
      });
  

    
    
    
}

function addTrigger(){
  var id=protocol_exp_id;

var time_idx=lineArr[0].length-1;
var t=lineArr[0][time_idx].time;
var obj={
  proto_exp_id:id,
  "time":t
};
  
  postAPI("/protocolExpTrigger/",obj,function(data){
    alert("Trigger Added!");
  });
}

function AddStimulus()
{
  var id=protocol_exp_id;
  
  var time_idx=lineArr[0].length-1;
  var t=lineArr[0][time_idx].time;
  var obj={
    proto_exp_id:id,
    "intensity": $("#sti_intensity").val(),
    "interval": $("#sti_interval").val(),
    "height": $("#sti_height").val(),
    "time":t,
    
  };
  
  sti_intensity=$("#sti_intensity").val();
  //sti_intensity=parseInt(sti_intensity*190/100)+10;
  sti_intensity = parseInt(sti_intensity)
  sti_interval=$("#sti_interval").val();
  sti_interval = parseInt(sti_interval)
  //sti_interval=parseInt(sti_interval*196/100)+4;

  sti_height=$("#sti_height").val();
  sti_height=parseInt(sti_height)
  //sti_height=parseInt(sti_height*4095/100);

  bluetoothService.getCharacteristic(WRITE_UUID).then(function (characteristic) {
                              console.log("characteristic1");console.log(characteristic);
                              deviceChar = characteristic;
                              const cmd_intense="102|"+sti_intensity;
                              var uint8array_intense = new TextEncoder().encode(cmd_intense);
                              deviceChar.writeValueWithoutResponse(uint8array_intense).then(function() { 
                                console.log("wrote1!!!!!!");
                                const cmd_interval="104|"+sti_interval;
                                var uint8array_interval = new TextEncoder().encode(cmd_interval);
                                deviceChar.writeValueWithoutResponse(uint8array_interval).then(function() { 
                                  console.log("wrote2!!!!!!");

                                  const cmd_height="106|"+sti_height;
                                  var uint8array_height = new TextEncoder().encode(cmd_height);
                                  deviceChar.writeValueWithoutResponse(uint8array_height).then(function() { 
                                    console.log("wrote3!!!!!!");
                                  });                              
                                });

                                });

                              });

    console.log(obj);
    postAPI("/protocolExpStimulus/",obj,function(data){
      alert("Added!");
      //      loadAndDisplayTable(1);
            $("#modal_setting_popup").modal("hide");


    });


  
}
function deleteMarker()
{
  
    deleteAPI("/protocolExpsEvent/"+cur_marker_id,{},function(data){
      alert("Deleted!");
      loadAndDisplayTableEvent(1);
      $("#modal_marker_popup").modal("hide");
    });

}
function pad2(n) {
  return (n < 10 ? '0' : '') + n; 
}
function timetotxt(t)
{
             return t.getFullYear() +'-'+
               pad2(t.getMonth() + 1) + '-'+
               pad2(t.getDate()) +' '+
               pad2(t.getHours()) +':'+
               pad2(t.getMinutes()) +':'+
               pad2(t.getSeconds());
    
}
</script>
  </body>
</html>
